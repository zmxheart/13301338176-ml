<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="Use of type erasing in the Deep Learning Library (DLL) project to reduce compilation time and results with different compilers.">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Partial type erasing in Deep Learning Library (DLL) to improve compilation time | Blog blog("Baptiste Wicht");</title>
<script src="/cdn-cgi/apps/head/98vpnawSZZMscPn4oDND-ZgswjM.js"></script><link href="../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../../rss.xml">
<link rel="canonical" href="http://baptiste-wicht.com/posts/2017/03/partial-type-erasing-deep-learning-library-dll-improve-compilation-time.html">
<!--[if lt IE 9]><script src="../../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Baptiste Wicht">
<link rel="prev" href="clang-tidy-static-analysis-integration-in-sonarqube.html" title="Use clang-tidy for static analysis and integration in Sonarqube" type="text/html">
<link rel="next" href="../04/publications-deep-learning-features-handwritten-keyword-spotting.html" title="Publications: Deep Learning Features for Handwritten Keyword Spotting" type="text/html">
<meta property="og:site_name" content='Blog blog("Baptiste Wicht");'>
<meta property="og:title" content="Partial type erasing in Deep Learning Library (DLL) to improve compila">
<meta property="og:url" content="http://baptiste-wicht.com/posts/2017/03/partial-type-erasing-deep-learning-library-dll-improve-compilation-time.html">
<meta property="og:description" content="Use of type erasing in the Deep Learning Library (DLL) project to reduce compilation time and results with different compilers.">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2017-03-15T07:43:44+01:00">
<meta property="article:tag" content="C++">
<meta property="article:tag" content="C++11">
<meta property="article:tag" content="clang">
<meta property="article:tag" content="Compilers">
<meta property="article:tag" content="dll">
<meta property="article:tag" content="etl">
<meta property="article:tag" content="gcc">
<meta property="article:tag" content="zapcc">
<link href="../../../favicon.ico" rel="icon" type="image/x-icon">
<link rel="publisher" href="https://plus.google.com/+BaptisteWicht">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-2175227-7', 'auto');
  var metas = document.getElementsByTagName('meta'), tagsList = [];
  for (var i=0; i<metas.length; i++) {
    if (metas[i].getAttribute('property') == 'article:tag') {
      tagsList.push( metas[i].getAttribute('content'));
    }
  }
  ga('set', 'dimension1', tagsList.join('|'));
  ga('send', 'pageview');
</script>
</head>
<body>

<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
<div class="container-fluid">

<div class="row">
<div class="col-sm-3 col-lg-2">
<nav class="navbar navbar-inverse navbar-fixed-side"><div class="navbar-header">
<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
<span class="sr-only">Toggle navigation</span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
</button>
<a class="navbar-brand" href="http://baptiste-wicht.com/">
<span id="blog-title">Blog blog("Baptiste Wicht");</span>
 </a>
</div>

<div class="collapse navbar-collapse navbar-ex1-collapse">
<ul class="nav navbar-nav">
<li>
<a href="../../../stories/about.html">About</a>
</li>
<li>
<a href="../../../stories/publications.html">Publications</a>
</li>
<li>
<a href="../../../stories/projects.html">Projects</a>
</li>
<li>
<a href="../../../categories/index.html">Tags</a>
</li>
<li>
<a href="../../../archive.html">Archives</a>
</li>
<li>
<a href="http://feeds.feedburner.com/BaptisteWicht">RSS</a>
</li>
<li class="navbar-content">
<h3>Related posts</h3>
</li>
<li><a href="../08/compiler-benchmark-gcc-clang-cpp-library-etl.html">Compiler benchmark GCC and Clang on C++ library (ETL)</a></li>
<li><a href="../../2016/11/zapcc-a-faster-cpp-compiler.html">zapcc - a faster C++ compiler</a></li>
<li><a href="release-zapcc-10-fast-cpp-compiler.html">Release of zapcc 1.0 - Fast C++ compiler</a></li>
<li><a href="../../2016/12/zapcc-cpp-compilation-speed-against-gcc-54-and-clang-39.html">zapcc C++ compilation speed against gcc 5.4 and clang 3.9</a></li>
<li><a href="disappointing-zapcc-performance-on-deep-learning-library-dll.html">Disappointing zapcc performance on Deep Learning Library (DLL)</a></li>
<li><a href="../../2016/09/blazing-fast-unit-test-compilation-with-doctest-11.html">Blazing fast unit test compilation with doctest 1.1</a></li>
<li class="navbar-block">
<li class="wicht-navbar-right">
<a target="_blank" title="Follow @wichtounet on Twitter" href="https://twitter.com/wichtounet">
<img src="../../../assets/img/twitter.png" alt="Follow @wichtounet on Twitter"></a>
</li>
<li class="wicht-navbar-right">
<a target="_blank" title="Follow +BaptisteWicht on Google+" href="https://plus.google.com/+BaptisteWicht">
<img src="../../../assets/img/google_plus.png" alt="Follow +BaptisteWicht on Google+"></a>
</li>
</ul>
</div>

</nav>
</div> 
<div class="col-sm-9 col-lg-10">
<div id="content"></div>
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">Partial type erasing in Deep Learning Library (DLL) to improve compilation time</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">
Baptiste Wicht
</span></p>
<p class="dateline"><a href="#" rel="bookmark"><time class="published dt-published" datetime="2017-03-15T07:43:44+01:00" itemprop="datePublished" title="2017-03-15 07:43">2017-03-15 07:43</time></a></p>
<p class="commentline">
<a href="partial-type-erasing-deep-learning-library-dll-improve-compilation-time.html#disqus_thread" data-disqus-identifier="cache/posts/2017/03/partial-type-erasing-deep-learning-library-dll-improve-compilation-time.html">Comments</a>
</p>
<p class="sourceline"><a href="partial-type-erasing-deep-learning-library-dll-improve-compilation-time.rst" class="sourcelink">Source</a></p>
</div>
</header><div class="e-content entry-content" itemprop="articleBody text">
<div>
<p>In a previous post, I compared the <a class="reference external" href="https://baptiste-wicht.com/posts/2017/03/disappointing-zapcc-performance-on-deep-learning-library-dll.html">compilation time on my Deep Learning Library (DLL) project with different compilers</a>. I realized that the compilation times were quickly going unreasonable for this library, especially for compiling the unit cases which clearly hurts the development of the library. Indeed, you want to be able to run the unit tests reasonably quickly after you integrated new changes.</p>
<div class="section" id="reduce-the-compilation-time">
<h2>Reduce the compilation time</h2>
<p>The first thing I did was to split the compilation in three executables: one for
the unit tests, one for the various performance tests and one for the various other
miscellaneous tests. With this, it is much faster to compile only the unit test
cases.</p>
<p>But this can be improved significantly more. In DLL a network is a variadic
template containing the list of layers, in order. In DLL, there are two main
different ways of declaring a neural networks. In the first version, the fast
version, the layers directly know their sizes:</p>
<pre class="code cpp"><a name="rest_code_f16feeb38686463faeb78f276a61043d-1"></a><span class="k">using</span> <span class="n">network_t</span> <span class="o">=</span>
<a name="rest_code_f16feeb38686463faeb78f276a61043d-2"></a>    <span class="n">dll</span><span class="o">::</span><span class="n">dbn_desc</span><span class="o">&lt;</span>
<a name="rest_code_f16feeb38686463faeb78f276a61043d-3"></a>        <span class="n">dll</span><span class="o">::</span><span class="n">dbn_layers</span><span class="o">&lt;</span>
<a name="rest_code_f16feeb38686463faeb78f276a61043d-4"></a>            <span class="n">dll</span><span class="o">::</span><span class="n">rbm_desc</span><span class="o">&lt;</span><span class="mi">28</span> <span class="o">*</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="n">dll</span><span class="o">::</span><span class="n">momentum</span><span class="p">,</span> <span class="n">dll</span><span class="o">::</span><span class="n">batch_size</span><span class="o">&lt;</span><span class="mi">64</span><span class="o">&gt;&gt;::</span><span class="n">layer_t</span><span class="p">,</span>
<a name="rest_code_f16feeb38686463faeb78f276a61043d-5"></a>            <span class="n">dll</span><span class="o">::</span><span class="n">rbm_desc</span><span class="o">&lt;</span><span class="mi">500</span>    <span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">dll</span><span class="o">::</span><span class="n">momentum</span><span class="p">,</span> <span class="n">dll</span><span class="o">::</span><span class="n">batch_size</span><span class="o">&lt;</span><span class="mi">64</span><span class="o">&gt;&gt;::</span><span class="n">layer_t</span><span class="p">,</span>
<a name="rest_code_f16feeb38686463faeb78f276a61043d-6"></a>            <span class="n">dll</span><span class="o">::</span><span class="n">rbm_desc</span><span class="o">&lt;</span><span class="mi">400</span>    <span class="p">,</span> <span class="mi">10</span><span class="p">,</span>  <span class="n">dll</span><span class="o">::</span><span class="n">momentum</span><span class="p">,</span> <span class="n">dll</span><span class="o">::</span><span class="n">batch_size</span><span class="o">&lt;</span><span class="mi">64</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">dll</span><span class="o">::</span><span class="n">hidden</span><span class="o">&lt;</span><span class="n">dll</span><span class="o">::</span><span class="n">unit_type</span><span class="o">::</span><span class="n">SOFTMAX</span><span class="o">&gt;&gt;::</span><span class="n">layer_t</span><span class="o">&gt;</span><span class="p">,</span>
<a name="rest_code_f16feeb38686463faeb78f276a61043d-7"></a>        <span class="n">dll</span><span class="o">::</span><span class="n">trainer</span><span class="o">&lt;</span><span class="n">dll</span><span class="o">::</span><span class="n">sgd_trainer</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">dll</span><span class="o">::</span><span class="n">batch_size</span><span class="o">&lt;</span><span class="mi">64</span><span class="o">&gt;&gt;::</span><span class="n">dbn_t</span><span class="p">;</span>
<a name="rest_code_f16feeb38686463faeb78f276a61043d-8"></a>
<a name="rest_code_f16feeb38686463faeb78f276a61043d-9"></a><span class="k">auto</span> <span class="n">network</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">network_t</span><span class="o">&gt;</span><span class="p">();</span>
<a name="rest_code_f16feeb38686463faeb78f276a61043d-10"></a><span class="n">network</span><span class="o">-&gt;</span><span class="n">pretrain</span><span class="p">(</span><span class="n">dataset</span><span class="p">.</span><span class="n">training_images</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
<a name="rest_code_f16feeb38686463faeb78f276a61043d-11"></a><span class="n">network</span><span class="o">-&gt;</span><span class="n">fine_tune</span><span class="p">(</span><span class="n">dataset</span><span class="p">.</span><span class="n">training_images</span><span class="p">,</span> <span class="n">dataset</span><span class="p">.</span><span class="n">training_labels</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
</pre>
<p>In my opinion, this is the best way to use DLL. This is the fastest and the
clearest. Moreover, the dimensions of the network can be validated at compile
time, which is always better than at runtime. However, the dimensions of the
network cannot be changed at runtime. For this, there is a different version,
the dynamic version:</p>
<pre class="code cpp"><a name="rest_code_7dba155d64d04952aa1bff84e2570a48-1"></a><span class="k">using</span> <span class="n">network_t</span> <span class="o">=</span>
<a name="rest_code_7dba155d64d04952aa1bff84e2570a48-2"></a>    <span class="n">dll</span><span class="o">::</span><span class="n">dbn_desc</span><span class="o">&lt;</span>
<a name="rest_code_7dba155d64d04952aa1bff84e2570a48-3"></a>        <span class="n">dll</span><span class="o">::</span><span class="n">dbn_layers</span><span class="o">&lt;</span>
<a name="rest_code_7dba155d64d04952aa1bff84e2570a48-4"></a>            <span class="n">dll</span><span class="o">::</span><span class="n">dyn_rbm_desc</span><span class="o">&lt;</span><span class="n">dll</span><span class="o">::</span><span class="n">momentum</span><span class="o">&gt;::</span><span class="n">layer_t</span><span class="p">,</span>
<a name="rest_code_7dba155d64d04952aa1bff84e2570a48-5"></a>            <span class="n">dll</span><span class="o">::</span><span class="n">dyn_rbm_desc</span><span class="o">&lt;</span><span class="n">dll</span><span class="o">::</span><span class="n">momentum</span><span class="o">&gt;::</span><span class="n">layer_t</span><span class="p">,</span>
<a name="rest_code_7dba155d64d04952aa1bff84e2570a48-6"></a>            <span class="n">dll</span><span class="o">::</span><span class="n">dyn_rbm_desc</span><span class="o">&lt;</span><span class="n">dll</span><span class="o">::</span><span class="n">momentum</span><span class="p">,</span> <span class="n">dll</span><span class="o">::</span><span class="n">hidden</span><span class="o">&lt;</span><span class="n">dll</span><span class="o">::</span><span class="n">unit_type</span><span class="o">::</span><span class="n">SOFTMAX</span><span class="o">&gt;&gt;::</span><span class="n">layer_t</span><span class="o">&gt;</span><span class="p">,</span>
<a name="rest_code_7dba155d64d04952aa1bff84e2570a48-7"></a>        <span class="n">dll</span><span class="o">::</span><span class="n">batch_size</span><span class="o">&lt;</span><span class="mi">64</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">dll</span><span class="o">::</span><span class="n">trainer</span><span class="o">&lt;</span><span class="n">dll</span><span class="o">::</span><span class="n">sgd_trainer</span><span class="o">&gt;&gt;::</span><span class="n">dbn_t</span><span class="p">;</span>
<a name="rest_code_7dba155d64d04952aa1bff84e2570a48-8"></a>
<a name="rest_code_7dba155d64d04952aa1bff84e2570a48-9"></a><span class="k">auto</span> <span class="n">network</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">network_t</span><span class="o">&gt;</span><span class="p">();</span>
<a name="rest_code_7dba155d64d04952aa1bff84e2570a48-10"></a>
<a name="rest_code_7dba155d64d04952aa1bff84e2570a48-11"></a><span class="n">network</span><span class="o">-&gt;</span><span class="k">template</span> <span class="n">layer_get</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">().</span><span class="n">init_layer</span><span class="p">(</span><span class="mi">28</span> <span class="o">*</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
<a name="rest_code_7dba155d64d04952aa1bff84e2570a48-12"></a><span class="n">network</span><span class="o">-&gt;</span><span class="k">template</span> <span class="n">layer_get</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">().</span><span class="n">init_layer</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">400</span><span class="p">);</span>
<a name="rest_code_7dba155d64d04952aa1bff84e2570a48-13"></a><span class="n">network</span><span class="o">-&gt;</span><span class="k">template</span> <span class="n">layer_get</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">().</span><span class="n">init_layer</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
<a name="rest_code_7dba155d64d04952aa1bff84e2570a48-14"></a><span class="n">network</span><span class="o">-&gt;</span><span class="k">template</span> <span class="n">layer_get</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">().</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
<a name="rest_code_7dba155d64d04952aa1bff84e2570a48-15"></a><span class="n">network</span><span class="o">-&gt;</span><span class="k">template</span> <span class="n">layer_get</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">().</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
<a name="rest_code_7dba155d64d04952aa1bff84e2570a48-16"></a><span class="n">network</span><span class="o">-&gt;</span><span class="k">template</span> <span class="n">layer_get</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">().</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
<a name="rest_code_7dba155d64d04952aa1bff84e2570a48-17"></a>
<a name="rest_code_7dba155d64d04952aa1bff84e2570a48-18"></a><span class="n">network</span><span class="o">-&gt;</span><span class="n">pretrain</span><span class="p">(</span><span class="n">dataset</span><span class="p">.</span><span class="n">training_images</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
<a name="rest_code_7dba155d64d04952aa1bff84e2570a48-19"></a><span class="n">network</span><span class="o">-&gt;</span><span class="n">fine_tune</span><span class="p">(</span><span class="n">dataset</span><span class="p">.</span><span class="n">training_images</span><span class="p">,</span> <span class="n">dataset</span><span class="p">.</span><span class="n">training_labels</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
</pre>
<p>This is a bit more verbose, but the configuration can be changed at runtime with
this system. Moreover, this is also faster to compile. On the other hand, there
is some performance slowdown.</p>
<p>There is also a third version that is a hybrid of the first version:</p>
<pre class="code cpp"><a name="rest_code_c95085d4c8b34af3ace718c536a89849-1"></a><span class="k">using</span> <span class="n">network_t</span> <span class="o">=</span>
<a name="rest_code_c95085d4c8b34af3ace718c536a89849-2"></a>    <span class="n">dll</span><span class="o">::</span><span class="n">dyn_dbn_desc</span><span class="o">&lt;</span>
<a name="rest_code_c95085d4c8b34af3ace718c536a89849-3"></a>        <span class="n">dll</span><span class="o">::</span><span class="n">dbn_layers</span><span class="o">&lt;</span>
<a name="rest_code_c95085d4c8b34af3ace718c536a89849-4"></a>            <span class="n">dll</span><span class="o">::</span><span class="n">rbm_desc</span><span class="o">&lt;</span><span class="mi">28</span> <span class="o">*</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="n">dll</span><span class="o">::</span><span class="n">momentum</span><span class="p">,</span> <span class="n">dll</span><span class="o">::</span><span class="n">batch_size</span><span class="o">&lt;</span><span class="mi">64</span><span class="o">&gt;&gt;::</span><span class="n">layer_t</span><span class="p">,</span>
<a name="rest_code_c95085d4c8b34af3ace718c536a89849-5"></a>            <span class="n">dll</span><span class="o">::</span><span class="n">rbm_desc</span><span class="o">&lt;</span><span class="mi">500</span>    <span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="n">dll</span><span class="o">::</span><span class="n">momentum</span><span class="p">,</span> <span class="n">dll</span><span class="o">::</span><span class="n">batch_size</span><span class="o">&lt;</span><span class="mi">64</span><span class="o">&gt;&gt;::</span><span class="n">layer_t</span><span class="p">,</span>
<a name="rest_code_c95085d4c8b34af3ace718c536a89849-6"></a>            <span class="n">dll</span><span class="o">::</span><span class="n">rbm_desc</span><span class="o">&lt;</span><span class="mi">400</span>    <span class="p">,</span> <span class="mi">10</span><span class="p">,</span>  <span class="n">dll</span><span class="o">::</span><span class="n">momentum</span><span class="p">,</span> <span class="n">dll</span><span class="o">::</span><span class="n">batch_size</span><span class="o">&lt;</span><span class="mi">64</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">dll</span><span class="o">::</span><span class="n">hidden</span><span class="o">&lt;</span><span class="n">dll</span><span class="o">::</span><span class="n">unit_type</span><span class="o">::</span><span class="n">SOFTMAX</span><span class="o">&gt;&gt;::</span><span class="n">layer_t</span><span class="o">&gt;</span><span class="p">,</span>
<a name="rest_code_c95085d4c8b34af3ace718c536a89849-7"></a>        <span class="n">dll</span><span class="o">::</span><span class="n">trainer</span><span class="o">&lt;</span><span class="n">dll</span><span class="o">::</span><span class="n">sgd_trainer</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">dll</span><span class="o">::</span><span class="n">batch_size</span><span class="o">&lt;</span><span class="mi">64</span><span class="o">&gt;&gt;::</span><span class="n">dbn_t</span><span class="p">;</span>
<a name="rest_code_c95085d4c8b34af3ace718c536a89849-8"></a>
<a name="rest_code_c95085d4c8b34af3ace718c536a89849-9"></a><span class="k">auto</span> <span class="n">network</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">network_t</span><span class="o">&gt;</span><span class="p">();</span>
<a name="rest_code_c95085d4c8b34af3ace718c536a89849-10"></a><span class="n">network</span><span class="o">-&gt;</span><span class="n">pretrain</span><span class="p">(</span><span class="n">dataset</span><span class="p">.</span><span class="n">training_images</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
<a name="rest_code_c95085d4c8b34af3ace718c536a89849-11"></a><span class="n">network</span><span class="o">-&gt;</span><span class="n">fine_tune</span><span class="p">(</span><span class="n">dataset</span><span class="p">.</span><span class="n">training_images</span><span class="p">,</span> <span class="n">dataset</span><span class="p">.</span><span class="n">training_labels</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
</pre>
<p>Only one line was changed compared to the first version, <code>dbn_desc</code>
becomes <code>dyn_dbn_desc</code>. What this changes is that all the layers are
automatically transformed into their dynamic versions and all the parameters are
propagated at runtime. This is a form a type erasing since the sizes will not be
propagated at compilation time. But this is simple since the types are simply
transformed from one type to another directly. Behind the scene, it's the
dynamic version using the front-end of the fast version. This is almost as fast
to compile as the dynamic version, but the code is much better. It executes the
same as the dynamic version.</p>
<p>If we compare the compilation time of the three versions when compiling a single
network and 5 different networks with different architectures, we get the
following results (with clang):</p>
<table border="1" class="docutils">
<colgroup>
<col width="52%">
<col width="48%">
</colgroup>
<thead valign="bottom"><tr>
<th class="head">Model</th>
<th class="head">Time [s]</th>
</tr></thead>
<tbody valign="top">
<tr>
<td>1 Fast</td>
<td>30</td>
</tr>
<tr>
<td>1 Dynamic</td>
<td>16.6</td>
</tr>
<tr>
<td>1 Hybrid</td>
<td>16.6</td>
</tr>
<tr>
<td>5 Fast</td>
<td>114</td>
</tr>
<tr>
<td>5 Dynamic</td>
<td>16.6</td>
</tr>
<tr>
<td>5 Hybrid</td>
<td>21.9</td>
</tr>
</tbody>
</table>
<p>Even with one single network, the compilation time is reduced by 44%. When five
different networks are compilation, time is reduced by 85%. This can be
explained easily. Indeed, for the hybrid and dynamic versions, the layers will
have the same type and therefore a lot of template instantiations will only be
done once instead of five times. This makes a lot of difference since almost
everything is template inside the library.</p>
<p>Unfortunately, this also has an impact on the runtime of the network:</p>
<table border="1" class="docutils">
<colgroup>
<col width="26%">
<col width="41%">
<col width="32%">
</colgroup>
<thead valign="bottom"><tr>
<th class="head">Model</th>
<th class="head">Pretrain [s]</th>
<th class="head">Train [s]</th>
</tr></thead>
<tbody valign="top">
<tr>
<td>Fast</td>
<td>195</td>
<td>114</td>
</tr>
<tr>
<td>Dynamic</td>
<td>203</td>
<td>123</td>
</tr>
<tr>
<td>Hybrid</td>
<td>204</td>
<td>122</td>
</tr>
</tbody>
</table>
<p>On average, for dense models, the slowdown is between 4% and 8%. For
convolutional models, it is between 10% and 25%. I will definitely work on
trying to make the dynamic and especially the hybrid version faster in the
future, most on the work should be on the matrix library (ETL) that is used.</p>
<p>Since for test cases, a 20% increase in runtime is not really a problem, tests
being fast already, I decided to add an option to DLL so that everything can be
compiled by default in hybrid model. By using a compilation flag, all the
<code>dbn_desc</code> are becoming <code>dyn_dbn_desc</code> and therefore each used
network is becoming a hybrid network. Without a single change in the code, the
compilation time of the entire library can be significantly improved, as seen in
the next section. This can also be used in user code to improve compilation
time during debugging and experiments and can be turned off for the final
training.</p>
<p>On my Continuous Integration system, I will build the system in both
configurations. This is not really an issue, since my personal machine at home
is more powerful than what I have available here.</p>
</div>
<div class="section" id="results">
<h2>Results</h2>
<p>On a first experiment, I measured the difference before and after this change on
the three executables of the library, with gcc:</p>
<table border="1" class="docutils">
<colgroup>
<col width="23%">
<col width="26%">
<col width="26%">
<col width="26%">
</colgroup>
<thead valign="bottom"><tr>
<th class="head">Model</th>
<th class="head">Unit [s]</th>
<th class="head">Perf [s]</th>
<th class="head">Misc [s]</th>
</tr></thead>
<tbody valign="top">
<tr>
<td>Before</td>
<td>1029</td>
<td>192</td>
<td>937</td>
</tr>
<tr>
<td>After</td>
<td>617</td>
<td>143</td>
<td>619</td>
</tr>
<tr>
<td>Speedup</td>
<td>40.03%</td>
<td>25.52%</td>
<td>33.93%</td>
</tr>
</tbody>
</table>
<p>It is clear that the speedups are very significant! The compilation is between
25% and 40% faster with the new option. Overall, this is a speedup of 36%!
I also noticed that the compilation takes significantly less memory than before.
Therefore, I decided to rerun the compiler benchmark on the library. In the
previous experiment, zapcc was taking so much memory that it was impossible to
use more than one thread. Let's see how it is faring now. The time to compile
the full unit tests is computed for each compiler. Let's start in debug mode:</p>
<table border="1" class="docutils">
<colgroup>
<col width="23%">
<col width="19%">
<col width="19%">
<col width="19%">
<col width="19%">
</colgroup>
<thead valign="bottom"><tr>
<th class="head">Debug</th>
<th class="head">-j1</th>
<th class="head">-j2</th>
<th class="head">-j3</th>
<th class="head">-j4</th>
</tr></thead>
<tbody valign="top">
<tr>
<td>clang-3.9</td>
<td>527</td>
<td>268</td>
<td>182</td>
<td>150</td>
</tr>
<tr>
<td>gcc-4.9.3</td>
<td>591</td>
<td>303</td>
<td>211</td>
<td>176</td>
</tr>
<tr>
<td>gcc-5.3.0</td>
<td>588</td>
<td>302</td>
<td>209</td>
<td>175</td>
</tr>
<tr>
<td>zapcc-1.0</td>
<td><strong>375</strong></td>
<td><strong>187</strong></td>
<td><strong>126</strong></td>
<td><strong>121</strong></td>
</tr>
</tbody>
</table>
<p>This time, zapcc is able to scale to four threads without problems. Moreover, it
is always the fastest compiler, by a significant margin, in this configuration.
It is followed by clang and then by gcc for which both versions are about the
same speed.</p>
<p>If we compile again in release mode:</p>
<table border="1" class="docutils">
<colgroup>
<col width="24%">
<col width="20%">
<col width="20%">
<col width="20%">
<col width="16%">
</colgroup>
<thead valign="bottom"><tr>
<th class="head">Release</th>
<th class="head">-j1</th>
<th class="head">-j2</th>
<th class="head">-j3</th>
<th class="head">-j4</th>
</tr></thead>
<tbody valign="top">
<tr>
<td>clang-3.9</td>
<td>1201</td>
<td>615</td>
<td>421</td>
<td>356</td>
</tr>
<tr>
<td>gcc-4.9.3</td>
<td>1041</td>
<td>541</td>
<td>385</td>
<td>321</td>
</tr>
<tr>
<td>gcc-5.3.0</td>
<td>1114</td>
<td>579</td>
<td>412</td>
<td>348</td>
</tr>
<tr>
<td>zapcc-1.0</td>
<td><strong>897</strong></td>
<td><strong>457</strong></td>
<td><strong>306</strong></td>
<td><em>306</em></td>
</tr>
</tbody>
</table>
<p>The difference in compilation time is very large, it's twice slower to compile
with all optimizations enabled. It also takes significantly more memory. Indeed,
zapcc was not able to compile with 4 threads. Nevertheless, even the results
with three threads are better than the other compilers using four threads. zapcc
is clearly the winner again on this test, followed by gcc4-9 which is faster
than gcc-5.3 which is itself faster than clang. It seems that while clang is
better at frontend than gcc, it is slower for optimizations. Note that this may
also be an indication that clang performs more optimizations than gcc and may
not be slower.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>By using some form of type erasing to simplify the templates types at compile
time, I was able to reduce the overall compilation time of my Deep Learning
Library (DLL) by 36%. Moreover, this can be done by switching a simple
compilation flag. This also very significantly reduce the memory used during the
compilation, allowing zapcc to to compile with up to three threads, compared
with only one before. This makes zapcc the fastest compiler again on this
benchmark. Overall, this will make debugging much easier on this library and
will save me a lot of time.</p>
<p>In the future, I plan to try to improve compilation time even more. I have a few
ideas, especially in ETL that should significantly improve the compilation time
but that will require a lot of time to implement, so that will likely have to
wait a while. In the coming days, I plan to work on the performance of DLL,
especially for stochastic gradient descent.</p>
<p>If you want more information on DLL, you can check out the
<a class="reference external" href="https://github.com/wichtounet/dll">dll Github repository</a>.</p>
</div>
</div>
</div>
<aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../../categories/c%2B%2B.html" rel="tag">C++</a></li>
<li><a class="tag p-category" href="../../../categories/c%2B%2B11.html" rel="tag">C++11</a></li>
<li><a class="tag p-category" href="../../../categories/clang.html" rel="tag">clang</a></li>
<li><a class="tag p-category" href="../../../categories/compilers.html" rel="tag">Compilers</a></li>
<li><a class="tag p-category" href="../../../categories/dll.html" rel="tag">dll</a></li>
<li><a class="tag p-category" href="../../../categories/etl.html" rel="tag">etl</a></li>
<li><a class="tag p-category" href="../../../categories/gcc.html" rel="tag">gcc</a></li>
<li><a class="tag p-category" href="../../../categories/zapcc.html" rel="tag">zapcc</a></li>
</ul>
<ul class="pager hidden-print">
<li class="previous">
<a href="clang-tidy-static-analysis-integration-in-sonarqube.html" rel="prev" title="Use clang-tidy for static analysis and integration in Sonarqube">Previous post</a>
</li>
<li class="next">
<a href="../04/publications-deep-learning-features-handwritten-keyword-spotting.html" rel="next" title="Publications: Deep Learning Features for Handwritten Keyword Spotting">Next post</a>
</li>
</ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
<div id="disqus_thread"></div>
<script>
        var disqus_shortname ="blogwichtounet",
            disqus_url="http://baptiste-wicht.com/posts/2017/03/partial-type-erasing-deep-learning-library-dll-improve-compilation-time.html",
        disqus_title="Partial type erasing in Deep Learning Library (DLL) to improve compilation time",
        disqus_identifier="cache/posts/2017/03/partial-type-erasing-deep-learning-library-dll-improve-compilation-time.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
<a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>
</section></article><script>var disqus_shortname="blogwichtounet";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>
</div> 
</div>

</div>



<footer>
Contents Â© 2017 <a href="/cdn-cgi/l/email-protection#6d0f0c1d19041e19081a040e05192d0a000c0401430e0200">Baptiste Wicht</a> - Powered by <a href="http://getnikola.com" rel="nofollow">Nikola</a> - License:
<a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="padding-left:5px;border-width:0" src="../../../assets/img/cc.png"></a>
<ul class="footer_inline_ul">
<li>
<a href="partial-type-erasing-deep-learning-library-dll-improve-compilation-time.rst" id="sourcelink">Source</a>
</li>
</ul></footer><script src="/cdn-cgi/scripts/78d64697/cloudflare-static/email-decode.min.js"></script><script src="../../../assets/js/all-nocdn.js"></script>
</body>
</html>
