<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>PVS-Studio on C++ Library Review | Blog blog("Baptiste Wicht");</title>
<script src="/cdn-cgi/apps/head/98vpnawSZZMscPn4oDND-ZgswjM.js"></script><link href="../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../../rss.xml">
<link rel="canonical" href="http://baptiste-wicht.com/posts/2016/12/pvs-studio-on-cpp-library-review.html">
<!--[if lt IE 9]><script src="../../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Baptiste Wicht">
<link rel="prev" href="cpp-compiler-benchmark-on-expression-templates-library-etl.html" title="C++ Compiler benchmark on Expression Templates Library (ETL)" type="text/html">
<link rel="next" href="../../2017/01/new-home-automation-system-with-domoticz.html" title="New home automation system with Domoticz" type="text/html">
<meta property="og:site_name" content='Blog blog("Baptiste Wicht");'>
<meta property="og:title" content="PVS-Studio on C++ Library Review">
<meta property="og:url" content="http://baptiste-wicht.com/posts/2016/12/pvs-studio-on-cpp-library-review.html">
<meta property="og:description" content="PVS-Studio is a commercial static analyzer for C, C++ and C#. It works in both
Windows and Linux.
It has been a long time since I wanted to test it on my projects. I contacted
The PVS-Studio team and ">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2016-12-20T09:40:12+01:00">
<meta property="article:tag" content="C++">
<meta property="article:tag" content="C++11">
<meta property="article:tag" content="C++14">
<meta property="article:tag" content="Review">
<meta property="article:tag" content="Tools">
<link href="../../../favicon.ico" rel="icon" type="image/x-icon">
<link rel="publisher" href="https://plus.google.com/+BaptisteWicht">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-2175227-7', 'auto');
  var metas = document.getElementsByTagName('meta'), tagsList = [];
  for (var i=0; i<metas.length; i++) {
    if (metas[i].getAttribute('property') == 'article:tag') {
      tagsList.push( metas[i].getAttribute('content'));
    }
  }
  ga('set', 'dimension1', tagsList.join('|'));
  ga('send', 'pageview');
</script>
</head>
<body>

<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
<div class="container-fluid">

<div class="row">
<div class="col-sm-3 col-lg-2">
<nav class="navbar navbar-inverse navbar-fixed-side"><div class="navbar-header">
<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
<span class="sr-only">Toggle navigation</span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
</button>
<a class="navbar-brand" href="http://baptiste-wicht.com/">
<span id="blog-title">Blog blog("Baptiste Wicht");</span>
</a>
</div>

<div class="collapse navbar-collapse navbar-ex1-collapse">
<ul class="nav navbar-nav">
<li>
<a href="../../../stories/about.html">About</a>
</li>
<li>
<a href="../../../stories/publications.html">Publications</a>
</li>
<li>
<a href="../../../stories/projects.html">Projects</a>
</li>
<li>
<a href="../../../categories/index.html">Tags</a>
</li>
<li>
<a href="../../../archive.html">Archives</a>
</li>
<li>
<a href="http://feeds.feedburner.com/BaptisteWicht">RSS</a>
</li>
<li class="navbar-content">
<h3>Related posts</h3>
</li>
<li><a href="../01/improve-dll-and-etl-compile-time-further.html">Improve DLL and ETL Compile Time further</a></li>
<li><a href="../../2015/06/continuous-performance-management-with-cpm-for-cpp.html">Continuous Performance Management with CPM for C++</a></li>
<li><a href="../../2015/07/simulate-static_if-with-c11c14.html">Simulate static_if with C++11/C++14</a></li>
<li><a href="../../2017/08/simplify-your-type-traits-with-c++14-variable-templates.html">Simplify your type traits with C++14 variable templates</a></li>
<li><a href="../../2015/03/named-optional-template-parameters-compile-time.html">Named Optional Template parameters to configure a class at compile-time</a></li>
<li><a href="../../2014/07/compile-integer-square-roots-at-compile-time-in-cpp.html">Compile integer Square Roots at compile-time in C++</a></li>
<li class="navbar-block">
<li class="wicht-navbar-right">
<a target="_blank" title="Follow @wichtounet on Twitter" href="https://twitter.com/wichtounet">
<img src="../../../assets/img/twitter.png" alt="Follow @wichtounet on Twitter"></a>
</li>
<li class="wicht-navbar-right">
<a target="_blank" title="Follow +BaptisteWicht on Google+" href="https://plus.google.com/+BaptisteWicht">
<img src="../../../assets/img/google_plus.png" alt="Follow +BaptisteWicht on Google+"></a>
</li>
</ul>
</div>

</nav>
</div> 
<div class="col-sm-9 col-lg-10">
<div id="content"></div>
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">PVS-Studio on C++ Library Review</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">
Baptiste Wicht
</span></p>
<p class="dateline"><a href="#" rel="bookmark"><time class="published dt-published" datetime="2016-12-20T09:40:12+01:00" itemprop="datePublished" title="2016-12-20 09:40">2016-12-20 09:40</time></a></p>
<p class="commentline">
<a href="pvs-studio-on-cpp-library-review.html#disqus_thread" data-disqus-identifier="cache/posts/2016/12/pvs-studio-on-cpp-library-review.html">Comments</a>
</p>
<p class="sourceline"><a href="pvs-studio-on-cpp-library-review.rst" class="sourcelink">Source</a></p>
</div>
</header><div class="e-content entry-content" itemprop="articleBody text">
<div>
<p>PVS-Studio is a commercial static analyzer for C, C++ and C#. It works in both
Windows and Linux.</p>
<p>It has been a long time since I wanted to test it on my projects. I contacted
The PVS-Studio team and they gave me a temporary license so that I can test the
tool and make a review.</p>
<p>I tried the static analyzer on my Expression Templates Library (ETL) project.
This is a heavily-templated C++ library. I tried it on Linux of course.</p>
<div class="section" id="usage">
<h2>Usage</h2>
<p>The installation is very simple, simply untar an archive and put the executables
in your PATH (or use absolute paths). There are also some deb and rpm packages
for some distributions. You need strace to make the analyzer work, it should be
available on any Linux platform.</p>
<p>The usage of PVS-Studio on Linux should be straightforward. First, you can use the
analyzer directly with make and it will detect the invocations of the compiler.
For instance, here is the command I used for ETL:</p>
<pre class="code text"><a name="rest_code_752c559723d548da94c2bd4eb5ff80c3-1"></a>pvs-studio-analyzer trace -- make -j5 debug/bin/etl_test
</pre>
<p>Note that you can use several threads without issues, which is really great.
There does not seem to be any slowdown at this stage, probably only collecting
compiler arguments.</p>
<p>This first step creates a strace_out file that will be used by the next stage.</p>
<p>Once, the compilation has been analyzed, you can generate the results with the
analyze function, for which you'll need a license. Here is what I did:</p>
<pre class="code text"><a name="rest_code_f580069643b4459c9ad1752698c2a779-1"></a>pvs-studio-analyzer analyze -l ~/pvs_studio/PVS-Studio.lic -j5
</pre>
<p>Unfortunately, this didn't work for me:</p>
<pre class="code text"><a name="rest_code_60665f89921a4298b44f12553e8ec726-1"></a>No compilation units found
<a name="rest_code_60665f89921a4298b44f12553e8ec726-2"></a>Analysis finished in 0:00:00.00
</pre>
<p>Apparently, it's not able to use the strace_out it generated itself...</p>
<p>Another possibility is to use the compilation database from clang to use
PVS-Studio. So I generated my compile_commands.json file again (it was not up to
date...) with <a class="reference external" href="https://github.com/rizsotto/Bear">Bear</a>. And then, you only
need to run the analyze step:</p>
<pre class="code text"><a name="rest_code_6b00f9eef835477b94c8c676bd66966c-1"></a>pvs-studio-analyzer analyze -l ~/pvs_studio/PVS-Studio.lic -j5
</pre>
<p>Make sure you have the same compiler configured than the one used to generate
the compilation database to avoid errors with compiler arguments.</p>
<p>Unfortunately, this just printed a load of crap on my console:</p>
<pre class="code text"><a name="rest_code_321fa4266d3d4657a65379ee2704342f-1"></a>(L8Pu(]-'Lo8h&gt;uo(_uv(uo2(-&gt;'2h_u(uo2(uvU2K h&gt;'o8a=}Lkk;x[G^%cuaa8acr[VS%
<a name="rest_code_321fa4266d3d4657a65379ee2704342f-2"></a>$ckUaoc8 c'8&gt;_-o-8&gt;U2cu/kau==-8&gt;c-=cU2]Uf=c U2=u%c&amp;kU__-&gt;j}<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="fe9dbe8b888bcc">[email&#160;protected]</a>%cJ
<a name="rest_code_321fa4266d3d4657a65379ee2704342f-3"></a>(L8Pu(]-'Lo8h&gt;uo(_uv(uo2(-&gt;'2h_u(uo2(uvU2K h&gt;'o8a=}Lkk;JVJ^%cuaa8acr[VS%
<a name="rest_code_321fa4266d3d4657a65379ee2704342f-4"></a>$ckUaoc8 c'8&gt;_-o-8&gt;U2cu/kau==-8&gt;c-=cU2]Uf=c U2=u%c&amp;kU__-&gt;j}<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="6f0c2f1a191a5d">[email&#160;protected]</a>%cJ
<a name="rest_code_321fa4266d3d4657a65379ee2704342f-5"></a>(L8Pu(]-'Lo8h&gt;uo(_uv(uo2(-&gt;'2h_u(uo2(uvU2K h&gt;'o8a=}Lkk;*[G^%cuaa8acr[VS%
<a name="rest_code_321fa4266d3d4657a65379ee2704342f-6"></a>$ckUaoc8 c'8&gt;_-o-8&gt;U2cu/kau==-8&gt;c-=cU2]Uf=c U2=u%c&amp;kU__-&gt;j}<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="b9daf9cccfcc8b">[email&#160;protected]</a>%cJ
<a name="rest_code_321fa4266d3d4657a65379ee2704342f-7"></a>(L8Pu(]-'Lo8h&gt;uo(_uv(uo2(-&gt;'2h_u(uo2(uvU2K h&gt;'o8a=}Lkk;b[b^%cuaa8acr[VS%
<a name="rest_code_321fa4266d3d4657a65379ee2704342f-8"></a>$ckUaoc8 c'8&gt;_-o-8&gt;U2cu/kau==-8&gt;c-=cU2]Uf=c U2=u%c&amp;kU__-&gt;j}<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="aecdeedbd8db9c">[email&#160;protected]</a>%cJ
<a name="rest_code_321fa4266d3d4657a65379ee2704342f-9"></a>(L8Pu(]-'Lo8h&gt;uo(_uv(uo2(-&gt;'2h_u(uo2(uvU2K h&gt;'o8a=}Lkk;[[x^%cuaa8acr[VS%
<a name="rest_code_321fa4266d3d4657a65379ee2704342f-10"></a>$ckUaoc8 c'8&gt;_-o-8&gt;U2cu/kau==-8&gt;c-=cU2]Uf=c U2=u%c&amp;kU__-&gt;j}<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="12715267646720">[email&#160;protected]</a>%cJ
</pre>
<p>Pretty nice, isn't it ?</p>
<p>Let's try again in a file:</p>
<pre class="code text"><a name="rest_code_76c68ac3fa004470bff70317545dddc3-1"></a>pvs-studio-analyzer analyze -o results.log -l ~/pvs_studio/PVS-Studio.lic -j5
</pre>
<p>The time is quite reasonable for the analysis, it took much less time than the
compilation time. In total, it took 88 seconds to analyze all the files. It's
much faster than the clang static analyzer.</p>
<p>This time it worked, but the log file is not readable, you need to convert it
again:</p>
<pre class="code text"><a name="rest_code_7fe83609152a4d95bffb4dbf29f1a676-1"></a>plog-converter -t errorfile -o errors results.log
</pre>
<p>And finally, you can read the results of the analysis in the errors file.</p>
</div>
<div class="section" id="results">
<h2>Results</h2>
<p>Overall, PVS-Studio found 236 messages in the ETL library, I was expecting more.
I also wish there was an HTML report that include the source code as well as the
error message. I had to lookup at the code for each message (you could integrate
it in vim and then use the quickfix window to do that). There are some
visualization but in things like QtCreator or LibreOffice which I don't have nor
want on my computer.</p>
<p>Let's look at the results. For each message, I'll include the message from
PVS-Studio and the code if it's relevant.</p>
<p>The first is about using the comma:</p>
<pre class="code text"><a name="rest_code_d1cd556acbc948daa757274fdb086395-1"></a>include/etl/traits.hpp:674:1: error: V521 Such expressions using the ',' operator are dangerous. Make sure the expression is correct.
<a name="rest_code_d1cd556acbc948daa757274fdb086395-2"></a>include/etl/traits.hpp:674:1: error: V685 Consider inspecting the return statement. The expression contains a comma.
</pre>
<pre class="code cpp"><a name="rest_code_56f52f0c63de49dab5e4937dde5d3b38-1"></a><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">E</span><span class="o">&gt;</span>
<a name="rest_code_56f52f0c63de49dab5e4937dde5d3b38-2"></a><span class="k">constexpr</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">dimensions</span><span class="p">(</span><span class="k">const</span> <span class="n">E</span><span class="o">&amp;</span> <span class="n">expr</span><span class="p">)</span> <span class="k">noexcept</span> <span class="p">{</span>
<a name="rest_code_56f52f0c63de49dab5e4937dde5d3b38-3"></a>    <span class="k">return</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">expr</span><span class="p">,</span> <span class="n">etl_traits</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;::</span><span class="n">dimensions</span><span class="p">();</span>
<a name="rest_code_56f52f0c63de49dab5e4937dde5d3b38-4"></a><span class="p">}</span>
</pre>
<p>Here I'm simply using the comma operand to ignore expr to avoid a warning. To
make this compile in C++11, you need to do it in one line otherwise it's not
a constexpr function. It's probably not perfect to use this construct, but there
is no problem here.</p>
<p>There is a bunch of these, let's filter them, it remains 207 warnings. Let's
jump to the next one:</p>
<pre class="code text"><a name="rest_code_d447255158b94c23a01e76d8401783ef-1"></a>include/etl/impl/blas/fft.hpp:29:1: error: V501 There are identical sub-expressions to the left and to the right of the '==' operator: (DFTI_SINGLE) == DFTI_SINGLE
</pre>
<pre class="code cpp"><a name="rest_code_1ffa634a24a04e80be401e49c3cf8bf6-1"></a><span class="kr">inline</span> <span class="kt">void</span> <span class="nf">fft_kernel</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">complex</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;*</span> <span class="n">in</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">s</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">complex</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;*</span> <span class="n">out</span><span class="p">)</span> <span class="p">{</span>
<a name="rest_code_1ffa634a24a04e80be401e49c3cf8bf6-2"></a>    <span class="n">DFTI_DESCRIPTOR_HANDLE</span> <span class="n">descriptor</span><span class="p">;</span>
<a name="rest_code_1ffa634a24a04e80be401e49c3cf8bf6-3"></a>
<a name="rest_code_1ffa634a24a04e80be401e49c3cf8bf6-4"></a>    <span class="kt">void</span><span class="o">*</span> <span class="n">in_ptr</span> <span class="o">=</span> <span class="k">const_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">in</span><span class="p">));</span>
<a name="rest_code_1ffa634a24a04e80be401e49c3cf8bf6-5"></a>
<a name="rest_code_1ffa634a24a04e80be401e49c3cf8bf6-6"></a>    <span class="n">DftiCreateDescriptor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">descriptor</span><span class="p">,</span> <span class="n">DFTI_SINGLE</span><span class="p">,</span> <span class="n">DFTI_COMPLEX</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span> <span class="c1">//Specify size and precision</span>
<a name="rest_code_1ffa634a24a04e80be401e49c3cf8bf6-7"></a>    <span class="n">DftiSetValue</span><span class="p">(</span><span class="n">descriptor</span><span class="p">,</span> <span class="n">DFTI_PLACEMENT</span><span class="p">,</span> <span class="n">DFTI_NOT_INPLACE</span><span class="p">);</span>         <span class="c1">//Out of place FFT</span>
<a name="rest_code_1ffa634a24a04e80be401e49c3cf8bf6-8"></a>    <span class="n">DftiCommitDescriptor</span><span class="p">(</span><span class="n">descriptor</span><span class="p">);</span>                                   <span class="c1">//Finalize the descriptor</span>
<a name="rest_code_1ffa634a24a04e80be401e49c3cf8bf6-9"></a>    <span class="n">DftiComputeForward</span><span class="p">(</span><span class="n">descriptor</span><span class="p">,</span> <span class="n">in_ptr</span><span class="p">,</span> <span class="n">out</span><span class="p">);</span>                        <span class="c1">//Compute the Forward FFT</span>
<a name="rest_code_1ffa634a24a04e80be401e49c3cf8bf6-10"></a>    <span class="n">DftiFreeDescriptor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">descriptor</span><span class="p">);</span>                                    <span class="c1">//Free the descriptor</span>
<a name="rest_code_1ffa634a24a04e80be401e49c3cf8bf6-11"></a><span class="p">}</span>
</pre>
<p>Unfortunately, the error is inside the MKL library. Here, I really don't think
it's an issue. There is pack of them. I forgot to exclude non-ETL code from the
results. Once filter from all dependencies, 137 messages remain.</p>
<pre class="code text"><a name="rest_code_111dd50645214eea853a6856282af689-1"></a>include/etl/eval_functors.hpp:157:1: warning: V560 A part of conditional expression is always false: !padding.
</pre>
<p>This is true, but not an issue since padding is a configuration constant that
enables the use of padding in vector and matrices. There was 27 of these at
different locations and with different configuration variables.</p>
<pre class="code text"><a name="rest_code_2fa08654a2444fc3a7666d703e66359d-1"></a>include/etl/op/sub_view.hpp:161:1: note: V688 The 'i' function argument possesses the same name as one of the class members, which can result in a confusion.
</pre>
<p>This is again true, but not a bug in this particular case. It is still helpful and
I ended up changing these to avoid confusion. Again, there was a few of these.</p>
<pre class="code text"><a name="rest_code_7d8f80daa6c642db8538f20b8bcfab0d-1"></a>etl/test/src/conv_multi_multi.cpp:23:1: error: V573 Uninitialized variable 'k' was used. The variable was used to initialize itself.
</pre>
<p>This one is in the test code:</p>
<pre class="code cpp"><a name="rest_code_60d95f6168254801a31c9a2a04517769-1"></a><span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">etl</span><span class="o">::</span><span class="n">dim</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">(</span><span class="n">K</span><span class="p">);</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span> <span class="p">{</span>
<a name="rest_code_60d95f6168254801a31c9a2a04517769-2"></a>    <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">etl</span><span class="o">::</span><span class="n">dim</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">(</span><span class="n">I</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
<a name="rest_code_60d95f6168254801a31c9a2a04517769-3"></a>        <span class="n">C_ref</span><span class="p">(</span><span class="n">k</span><span class="p">)(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">conv_2d_valid</span><span class="p">(</span><span class="n">I</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">K</span><span class="p">(</span><span class="n">k</span><span class="p">));</span> <span class="c1">// HERE</span>
<a name="rest_code_60d95f6168254801a31c9a2a04517769-4"></a>    <span class="p">}</span>
<a name="rest_code_60d95f6168254801a31c9a2a04517769-5"></a><span class="p">}</span>
</pre>
<p>I don't see any error, k is initialized correctly to zero in the first loop.
This is a <strong>false positive</strong> for me. There were several of these in different
places. It seems to that the use of the operator() is confusing for PVS-Studio.</p>
<pre class="code text"><a name="rest_code_b3dc5441d3e34bdeae62788ed1b8abb9-1"></a>include/etl/traits.hpp:703:1: note: V659 Declarations of functions with 'rows' name differ in the 'const' keyword only, but the bodies of these functions have different composition. This is suspicious and can possibly be an error. Check lines: 693, 703.
</pre>
<pre class="code cpp"><a name="rest_code_7304c0f2a47a47e4ac438da342420d7f-1"></a><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">E</span><span class="p">,</span> <span class="n">cpp_disable_if</span><span class="p">(</span><span class="n">decay_traits</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;::</span><span class="n">is_fast</span><span class="p">)</span><span class="o">&gt;</span>
<a name="rest_code_7304c0f2a47a47e4ac438da342420d7f-2"></a><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">rows</span><span class="p">(</span><span class="k">const</span> <span class="n">E</span><span class="o">&amp;</span> <span class="n">expr</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//693</span>
<a name="rest_code_7304c0f2a47a47e4ac438da342420d7f-3"></a>    <span class="k">return</span> <span class="n">etl_traits</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;::</span><span class="n">dim</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<a name="rest_code_7304c0f2a47a47e4ac438da342420d7f-4"></a><span class="p">}</span>
<a name="rest_code_7304c0f2a47a47e4ac438da342420d7f-5"></a>
<a name="rest_code_7304c0f2a47a47e4ac438da342420d7f-6"></a><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">E</span><span class="p">,</span> <span class="n">cpp_enable_if</span><span class="p">(</span><span class="n">decay_traits</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;::</span><span class="n">is_fast</span><span class="p">)</span><span class="o">&gt;</span>
<a name="rest_code_7304c0f2a47a47e4ac438da342420d7f-7"></a><span class="k">constexpr</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">rows</span><span class="p">(</span><span class="k">const</span> <span class="n">E</span><span class="o">&amp;</span> <span class="n">expr</span><span class="p">)</span> <span class="k">noexcept</span> <span class="p">{</span> <span class="c1">//703</span>
<a name="rest_code_7304c0f2a47a47e4ac438da342420d7f-8"></a>    <span class="k">return</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">expr</span><span class="p">,</span> <span class="n">etl_traits</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;::</span><span class="k">template</span> <span class="n">dim</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">();</span>
<a name="rest_code_7304c0f2a47a47e4ac438da342420d7f-9"></a><span class="p">}</span>
</pre>
<p>Unfortunately, this is again a <strong>false positive</strong> because PVS-Studio failed to
recognized SFINAE and therefore the warning is wrong.</p>
<pre class="code text"><a name="rest_code_eb53724f5d234dfa905dafc7af1d94cc-1"></a>include/etl/builder/expression_builder.hpp:345:1: note: V524 It is odd that the body of '&gt;&gt;=' function is fully equivalent to the body of '*=' function.
</pre>
<p>This one is interesting indeed. It is true that they are exactly because in ETL
&gt;&gt; is used for scalar element-wise multiplication. This is quite interesting that
PVS-Studio points that out. There was a few of these oddities but all were
normal in the library.</p>
<pre class="code text"><a name="rest_code_a1311dfae763417186e8671f1800b60f-1"></a>etl/test/src/compare.cpp:23:1: error: V501 There are identical sub-expressions to the left and to the right of the '!=' operator: a != a
</pre>
<p>Again, it is nice that PVS-Studio finds that, but this is done on purpose on the
tests to compare an object to itself. If I remove all the oddities in the test
cases, there are only 17 left in the headers. None of the warnings on the test
case was serious, but there was no more false positives either, so that's great.</p>
<pre class="code text"><a name="rest_code_095a52ec6f7f49d0b15f39d99c079ea4-1"></a>include/etl/impl/vec/sum.hpp:92:1: error: V591 Non-void function should return a value.
</pre>
<pre class="code cpp"><a name="rest_code_a0b062010d854e0fba1faada4751e938-1"></a><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">L</span><span class="p">,</span> <span class="n">cpp_disable_if</span><span class="p">((</span><span class="n">vec_enabled</span> <span class="o">&amp;&amp;</span> <span class="n">all_vectorizable</span><span class="o">&lt;</span><span class="n">vector_mode</span><span class="p">,</span> <span class="n">L</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">))</span><span class="o">&gt;</span>
<a name="rest_code_a0b062010d854e0fba1faada4751e938-2"></a><span class="n">value_t</span><span class="o">&lt;</span><span class="n">L</span><span class="o">&gt;</span> <span class="n">sum</span><span class="p">(</span><span class="k">const</span> <span class="n">L</span><span class="o">&amp;</span> <span class="n">lhs</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">first</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">last</span><span class="p">)</span> <span class="p">{</span>
<a name="rest_code_a0b062010d854e0fba1faada4751e938-3"></a>    <span class="n">cpp_unused</span><span class="p">(</span><span class="n">lhs</span><span class="p">);</span>
<a name="rest_code_a0b062010d854e0fba1faada4751e938-4"></a>    <span class="n">cpp_unused</span><span class="p">(</span><span class="n">first</span><span class="p">);</span>
<a name="rest_code_a0b062010d854e0fba1faada4751e938-5"></a>    <span class="n">cpp_unused</span><span class="p">(</span><span class="n">last</span><span class="p">);</span>
<a name="rest_code_a0b062010d854e0fba1faada4751e938-6"></a>    <span class="n">cpp_unreachable</span><span class="p">(</span><span class="s">"vec::sum called with invalid parameters"</span><span class="p">);</span>
<a name="rest_code_a0b062010d854e0fba1faada4751e938-7"></a><span class="p">}</span>
</pre>
<p>This one is interesting. It's not a false positive since indeed the function
does not return a value, but there is a __builtin_unreachable() inside the
function and it cannot be called. In my opinion, the static analyzer should be
able to handle that, but this is really a corner case.</p>
<pre class="code text"><a name="rest_code_b219d74dbaed49e98ecdd5fe7500fe03-1"></a>include/etl/sparse.hpp:148:1: note: V550 An odd precise comparison: a == 0.0. It's probably better to use a comparison with defined precision: fabs(A - B) &lt; Epsilon.
</pre>
<pre class="code cpp"><a name="rest_code_59bd3ebbaf2c46708a11e8a0c16cd6e2-1"></a><span class="kr">inline</span> <span class="kt">bool</span> <span class="nf">is_zero</span><span class="p">(</span><span class="kt">double</span> <span class="n">a</span><span class="p">)</span> <span class="p">{</span>
<a name="rest_code_59bd3ebbaf2c46708a11e8a0c16cd6e2-2"></a>    <span class="k">return</span> <span class="n">a</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">;</span>
<a name="rest_code_59bd3ebbaf2c46708a11e8a0c16cd6e2-3"></a><span class="p">}</span>
</pre>
<p>This is not false, but again this is intended because of the comparison to zero
for a sparse matrix. There were 10 of these in the same class.</p>
<pre class="code text"><a name="rest_code_c73e32153c654273bcf8e44990c0bd04-1"></a>include/etl/impl/blas/fft.hpp:562:1: note: V656 Variables 'a_padded', 'b_padded' are initialized through the call to the same function. It's probably an error or un-optimized code. Consider inspecting the 'etl::size(c)' expression. Check lines: 561, 562.
</pre>
<pre class="code cpp"><a name="rest_code_04f673f4a3704d26bbcd988b927a6c9e-1"></a><span class="n">dyn_vector</span><span class="o">&lt;</span><span class="n">etl</span><span class="o">::</span><span class="n">complex</span><span class="o">&lt;</span><span class="n">type</span><span class="o">&gt;&gt;</span> <span class="n">a_padded</span><span class="p">(</span><span class="n">etl</span><span class="o">::</span><span class="n">size</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
<a name="rest_code_04f673f4a3704d26bbcd988b927a6c9e-2"></a><span class="n">dyn_vector</span><span class="o">&lt;</span><span class="n">etl</span><span class="o">::</span><span class="n">complex</span><span class="o">&lt;</span><span class="n">type</span><span class="o">&gt;&gt;</span> <span class="n">b_padded</span><span class="p">(</span><span class="n">etl</span><span class="o">::</span><span class="n">size</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
</pre>
<p>It's indeed constructed with the same size, but for me I don't think it's an
odd pattern. I would not consider that as a warning, especially since it's
a constructor and not a assignment.</p>
<pre class="code text"><a name="rest_code_552292314a2a423b8527c0a46569b066-1"></a>include/etl/dyn_base.hpp:312:1: warning: V690 The 'dense_dyn_base' class implements a copy constructor, but lacks the '=' operator. It is dangerous to use such a class.
</pre>
<p>This is again a kind of corner case in the library because it's a base class
and the assignment is different between the sub classes and not a real
assignment in the C++ sense.</p>
<pre class="code text"><a name="rest_code_30fc09ec90d6491d88e8d60d9b36579b-1"></a>include/etl/impl/reduc/conv_multi.hpp:657:1: warning: V711 It is dangerous to create a local variable within a loop with a same name as a variable controlling this loop.
</pre>
<pre class="code cpp"><a name="rest_code_6b882fcce86f443e9696906ac056a024-1"></a><span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="n">C</span><span class="p">;</span> <span class="o">++</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
<a name="rest_code_6b882fcce86f443e9696906ac056a024-2"></a>    <span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">K</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span> <span class="p">{</span>
<a name="rest_code_6b882fcce86f443e9696906ac056a024-3"></a>        <span class="n">conv</span><span class="p">(</span><span class="n">k</span><span class="p">)(</span><span class="n">c</span><span class="p">)</span> <span class="o">=</span> <span class="n">conv_temp</span><span class="p">(</span><span class="n">c</span><span class="p">)(</span><span class="n">k</span><span class="p">);</span>
<a name="rest_code_6b882fcce86f443e9696906ac056a024-4"></a>    <span class="p">}</span>
<a name="rest_code_6b882fcce86f443e9696906ac056a024-5"></a><span class="p">}</span>
</pre>
<p>This is again a false positive... It really seems that PVS-Studio is not able to
handle the operator().</p>
<pre class="code text"><a name="rest_code_6c7ed72cd5a74f9ebe874565aca49a35-1"></a>include/etl/impl/pooling.hpp:396:1: error: V501 There are identical sub-expressions to the left and to the right of the '||' operator: P1 || P2 || P1
</pre>
<pre class="code cpp"><a name="rest_code_167a26b701f8409b9fcd72ea284ad765-1"></a><span class="k">template</span> <span class="o">&lt;</span><span class="kt">size_t</span> <span class="n">C1</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">C2</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">C3</span><span class="p">,</span><span class="kt">size_t</span> <span class="n">S1</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">S2</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">S3</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">P1</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">P2</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">P3</span><span class="p">,</span> <span class="k">typename</span> <span class="n">A</span><span class="p">,</span> <span class="k">typename</span> <span class="n">M</span><span class="o">&gt;</span>
<a name="rest_code_167a26b701f8409b9fcd72ea284ad765-2"></a><span class="k">static</span> <span class="kt">void</span> <span class="n">apply</span><span class="p">(</span><span class="k">const</span> <span class="n">A</span><span class="o">&amp;</span> <span class="n">sub</span><span class="p">,</span> <span class="n">M</span><span class="o">&amp;&amp;</span> <span class="n">m</span><span class="p">)</span> <span class="p">{</span>
<a name="rest_code_167a26b701f8409b9fcd72ea284ad765-3"></a>    <span class="k">const</span> <span class="kt">size_t</span> <span class="n">o1</span> <span class="o">=</span> <span class="p">(</span><span class="n">etl</span><span class="o">::</span><span class="n">dim</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span> <span class="o">-</span> <span class="n">C1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">P1</span><span class="p">)</span> <span class="o">/</span> <span class="n">S1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<a name="rest_code_167a26b701f8409b9fcd72ea284ad765-4"></a>    <span class="k">const</span> <span class="kt">size_t</span> <span class="n">o2</span> <span class="o">=</span> <span class="p">(</span><span class="n">etl</span><span class="o">::</span><span class="n">dim</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span> <span class="o">-</span> <span class="n">C2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">P2</span><span class="p">)</span> <span class="o">/</span> <span class="n">S2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<a name="rest_code_167a26b701f8409b9fcd72ea284ad765-5"></a>    <span class="k">const</span> <span class="kt">size_t</span> <span class="n">o3</span> <span class="o">=</span> <span class="p">(</span><span class="n">etl</span><span class="o">::</span><span class="n">dim</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span> <span class="o">-</span> <span class="n">C3</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">P3</span><span class="p">)</span> <span class="o">/</span> <span class="n">S3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<a name="rest_code_167a26b701f8409b9fcd72ea284ad765-6"></a>
<a name="rest_code_167a26b701f8409b9fcd72ea284ad765-7"></a>    <span class="k">if</span><span class="p">(</span><span class="n">P1</span> <span class="o">||</span> <span class="n">P2</span> <span class="o">||</span> <span class="n">P1</span><span class="p">){</span>
</pre>
<p>Last but not least, this time, it's entirely true and it's in fact a bug in my
code! The condition should be written like this:</p>
<pre class="code cpp"><a name="rest_code_be83421ee5314baaaa1c96d426e6e9c0-1"></a><span class="k">if</span><span class="p">(</span><span class="n">P1</span> <span class="o">||</span> <span class="n">P2</span> <span class="o">||</span> <span class="n">P3</span><span class="p">){</span>
</pre>
<p>This is now fixed in the master of ETL.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>The installation was pretty easy, but the usage was not as easy as it could
because the first method by analyzing the build system did not work.
Fortunately, the system supports using the Clang compilation database directly
and therefore it was possible to use.</p>
<p>Overall, it found 236 warnings on my code base (heavily templated library).
Around 50 of them were in some of the extend libraries, but I forgot to filter
them out. The quality of the results is pretty good in my opinion. It was able
to <strong>find a bug</strong> in my implementation of pooling with padding. Unfortunately,
there was quite a few false positives, due to SFINAE, bad handling of the
operator() and no handling of __builtin_unreachable. The remaining were all
correct, but were not bug considering their usages.</p>
<p>To conclude, I think it's a great static analyzer that is really fast compared
to other one in the market. There are a few false positives, but it's really not
bad compared to other tools and some of the messages are really great. An HTML
report including the source code would be great as well.</p>
<p>If you want more information, you can consult
<a class="reference external" href="http://www.viva64.com/en/pvs-studio/">the official site</a>. There is even a way
to use it on open-source code for free, but you have to add comments on top of
each of your files.</p>
<p>I hope it was helpful ;)</p>
</div>
</div>
</div>
<aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../../categories/c%2B%2B.html" rel="tag">C++</a></li>
<li><a class="tag p-category" href="../../../categories/c%2B%2B11.html" rel="tag">C++11</a></li>
<li><a class="tag p-category" href="../../../categories/c%2B%2B14.html" rel="tag">C++14</a></li>
<li><a class="tag p-category" href="../../../categories/review.html" rel="tag">Review</a></li>
<li><a class="tag p-category" href="../../../categories/tools.html" rel="tag">Tools</a></li>
</ul>
<ul class="pager hidden-print">
<li class="previous">
<a href="cpp-compiler-benchmark-on-expression-templates-library-etl.html" rel="prev" title="C++ Compiler benchmark on Expression Templates Library (ETL)">Previous post</a>
</li>
<li class="next">
<a href="../../2017/01/new-home-automation-system-with-domoticz.html" rel="next" title="New home automation system with Domoticz">Next post</a>
</li>
</ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
<div id="disqus_thread"></div>
<script src="/cdn-cgi/scripts/78d64697/cloudflare-static/email-decode.min.js"></script><script>
        var disqus_shortname ="blogwichtounet",
            disqus_url="http://baptiste-wicht.com/posts/2016/12/pvs-studio-on-cpp-library-review.html",
        disqus_title="PVS-Studio on C++ Library Review",
        disqus_identifier="cache/posts/2016/12/pvs-studio-on-cpp-library-review.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
<a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>
</section></article><script>var disqus_shortname="blogwichtounet";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>
</div> 
</div>

</div>



<footer>
Contents Â© 2017 <a href="/cdn-cgi/l/email-protection#8eeceffefae7fdfaebf9e7ede6facee9e3efe7e2a0ede1e3">Baptiste Wicht</a> - Powered by <a href="http://getnikola.com" rel="nofollow">Nikola</a> - License:
<a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="padding-left:5px;border-width:0" src="../../../assets/img/cc.png"></a>
<ul class="footer_inline_ul">
<li>
<a href="pvs-studio-on-cpp-library-review.rst" id="sourcelink">Source</a>
</li>
</ul></footer><script src="/cdn-cgi/scripts/78d64697/cloudflare-static/email-decode.min.js"></script><script src="../../../assets/js/all-nocdn.js"></script>
</body>
</html>
