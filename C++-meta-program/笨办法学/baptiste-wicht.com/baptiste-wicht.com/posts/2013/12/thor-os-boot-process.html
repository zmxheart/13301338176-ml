<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Thor OS: Boot Process | Blog blog("Baptiste Wicht");</title>
<script src="/cdn-cgi/apps/head/98vpnawSZZMscPn4oDND-ZgswjM.js"></script><link href="../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../../rss.xml">
<link rel="canonical" href="http://baptiste-wicht.com/posts/2013/12/thor-os-boot-process.html">
<!--[if lt IE 9]><script src="../../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Baptiste Wicht">
<link rel="prev" href="new-hobby-project-thor-os-64bit-operating-system-c.html" title="New hobby project: Thor-OS, 64bit Operating System in C++" type="text/html">
<link rel="next" href="zabbix-low-level-discovery-cores-cpus-hard-disk.html" title="Zabbix - Low Level Discovery of cores, CPUs and Hard Disk" type="text/html">
<meta property="og:site_name" content='Blog blog("Baptiste Wicht");'>
<meta property="og:title" content="Thor OS: Boot Process">
<meta property="og:url" content="http://baptiste-wicht.com/posts/2013/12/thor-os-boot-process.html">
<meta property="og:description" content="Some time ago, I started a hobby project: writing a new operating system. I'm not trying to create a concurrent to Linux, I'm just trying to learn some more stuff about operating systems. I'm gonna tr">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2013-12-23T09:18:01+01:00">
<meta property="article:tag" content="Assembly">
<meta property="article:tag" content="C++">
<meta property="article:tag" content="Operating Systems">
<meta property="article:tag" content="osdev">
<meta property="article:tag" content="thor">
<link href="../../../favicon.ico" rel="icon" type="image/x-icon">
<link rel="publisher" href="https://plus.google.com/+BaptisteWicht">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-2175227-7', 'auto');
  var metas = document.getElementsByTagName('meta'), tagsList = [];
  for (var i=0; i<metas.length; i++) {
    if (metas[i].getAttribute('property') == 'article:tag') {
      tagsList.push( metas[i].getAttribute('content'));
    }
  }
  ga('set', 'dimension1', tagsList.join('|'));
  ga('send', 'pageview');
</script>
</head>
<body>

<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
<div class="container-fluid">

<div class="row">
<div class="col-sm-3 col-lg-2">
<nav class="navbar navbar-inverse navbar-fixed-side"><div class="navbar-header">
<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
<span class="sr-only">Toggle navigation</span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
</button>
<a class="navbar-brand" href="http://baptiste-wicht.com/">
<span id="blog-title">Blog blog("Baptiste Wicht");</span>
</a>
</div>

<div class="collapse navbar-collapse navbar-ex1-collapse">
<ul class="nav navbar-nav">
<li>
<a href="../../../stories/about.html">About</a>
</li>
<li>
<a href="../../../stories/publications.html">Publications</a>
</li>
<li>
<a href="../../../stories/projects.html">Projects</a>
</li>
<li>
<a href="../../../categories/index.html">Tags</a>
</li>
<li>
<a href="../../../archive.html">Archives</a>
</li>
<li>
<a href="http://feeds.feedburner.com/BaptisteWicht">RSS</a>
</li>
<li class="navbar-content">
<h3>Related posts</h3>
</li>
<li><a href="new-hobby-project-thor-os-64bit-operating-system-c.html">New hobby project: Thor-OS, 64bit Operating System in C++</a></li>
<li><a href="../../2016/08/update-thor-thesis-and-publications.html">Update: Thor, Thesis and Publications</a></li>
<li><a href="../../2011/11/dynamic-memory-allocation-intel-assembly-linux.html">Dynamic memory allocation in Intel Assembly on Linux</a></li>
<li><a href="../../2012/08/memory-manager-intel-assembly-64-linux.html">Memory Manager in 64bits Intel Assembly on Linux</a></li>
<li><a href="../../2012/03/introduction-64-bit-intel-assembly-language-programming-linux-book-review.html">Introduction to 64 Bit Intel Assembly Language Programming for Linux - Book Review</a></li>
<li><a href="../../2010/08/presentation-usage-h2-database-engine.html">Presentation and use of H2 Database Engine</a></li>
<li class="navbar-block">
<li class="wicht-navbar-right">
<a target="_blank" title="Follow @wichtounet on Twitter" href="https://twitter.com/wichtounet">
<img src="../../../assets/img/twitter.png" alt="Follow @wichtounet on Twitter"></a>
</li>
<li class="wicht-navbar-right">
<a target="_blank" title="Follow +BaptisteWicht on Google+" href="https://plus.google.com/+BaptisteWicht">
<img src="../../../assets/img/google_plus.png" alt="Follow +BaptisteWicht on Google+"></a>
</li>
</ul>
</div>

</nav>
</div> 
<div class="col-sm-9 col-lg-10">
<div id="content"></div>
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">Thor OS: Boot Process</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">
Baptiste Wicht
</span></p>
<p class="dateline"><a href="#" rel="bookmark"><time class="published dt-published" datetime="2013-12-23T09:18:01+01:00" itemprop="datePublished" title="2013-12-23 09:18">2013-12-23 09:18</time></a></p>
<p class="commentline">
<a href="thor-os-boot-process.html#disqus_thread" data-disqus-identifier="cache/posts/2013/12/thor-os-boot-process.html">Comments</a>
</p>
<p class="sourceline"><a href="thor-os-boot-process.wp" class="sourcelink">Source</a></p>
</div>
</header><div class="e-content entry-content" itemprop="articleBody text">
<div>
<p>Some time ago, I started a hobby project: <a title="New hobby project: Thor-OS, 64bit Operating System in C++" href="http://www.baptiste-wicht.com/2013/12/new-hobby-project-thor-os-64bit-operating-system-c/">writing a new operating system</a>. I'm not trying to create a concurrent to Linux, I'm just trying to learn some more stuff about operating systems. I'm gonna try to write some posts about this kernel on this blog.</p>
<p>In this post, I'll describe the boot process I've written for this operating system.</p>
<h3>Bootloader Step</h3>
<p>The first step is of course the bootloader. The bootloader is in the MBR and is loaded by the system at 0x7C00.</p>
<p>I'm doing the bootloading in two stages. The first stage (one sector) print some messages and then load the second stage (one sector) from floppy at 0x900. The goal of doing it in two stages is just to be able to overwrite the bootloader memory by the stage. The second stage loads the kernel into memory from floppy. The kernel is loaded at 0x1000 and then run directly.</p>
<p>The bootloader stages are written in assembly.</p>
<h3>Real mode</h3>
<p>When the processor, it boots in real mode (16 bits) and you have to setup plenty of things before you can go into long mode (64 bits). So the first steps of the kernel are running in 16 bits. The kernel is mostly written in C++ with some inline assembly.</p>
<p>Here are all the things that are done in this mode:</p>
<ol>
<li>The memory is inspected using BIOS E820 function. It is necessary to do that at this point since BIOS function calls are not available after going to protected mode. This function gives a map of the available memory. The map is used later by the dynamic memory allocator.</li>
<li>The interrupts are disabled and a fake Interrupt Descriptor Table is configured to make sure no interrupt are thrown in protected mode</li>
<li>The Global Descriptor Table is setup. This table describes the different portion of the memory and what each process can do with each portion of the memory. I have three descriptors: a 32bit code segment, a data segment and a 64bit code segment.</li>
<li>Protected mode is activated by setting PE bit of CR0 control register.</li>
<li>Disable paging</li>
<li>Jump to the next step. It is necessary to use a far jump so that the code segment is changed.</li>
</ol>
<h3>Protected Mode</h3>
<p>At this point, the processor is running in protected mode (32 bits). BIOS interrupts are not available anymore.</p>
<p>Again, several steps are necessary:</p>
<ol>
<li>To be able to use all memory, Physical Address Extensions are activated.</li>
<li>Long Mode is enabled by setting the EFER.LME bit.</li>
<li>Paging is setup, the first MiB of memory is mapped to the exact same virtual addresses.</li>
<li>The address of the Page-Map Level 4 Table is set in the CR0 register.</li>
<li>Finally paging is activated.</li>
<li>Jump to the real mode kernel, again by using a far jump to change code segment.</li>
</ol>
<h3>Real Mode</h3>
<p>The kernel finally runs in 64 bits.</p>
<p>There are still some initialization steps that needs to be done:</p>
<ol>
<li>SSE extensions are enabled.</li>
<li>The final Interrupt Descriptor Table is setup.</li>
<li>ISRs are created for each possible processor exception</li>
<li>The IRQs are installed in the IDT</li>
<li>Interrupts are enabled</li>
</ol>
<p>At this point, is kernel is fully loaded and starts initialization stuff like loading drivers, preparing memory, setting up timers...</p>
<p>If you want more information about this process, you can read the different source files involved (stage1.asm, stage2.asm, boot_16.cpp, boot_32.cpp and kernel.cpp) and if you have any question, you can comment on this post.</p>
</div>
</div>
<aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../../categories/assembly.html" rel="tag">Assembly</a></li>
<li><a class="tag p-category" href="../../../categories/c%2B%2B.html" rel="tag">C++</a></li>
<li><a class="tag p-category" href="../../../categories/operating-systems.html" rel="tag">Operating Systems</a></li>
<li><a class="tag p-category" href="../../../categories/osdev.html" rel="tag">osdev</a></li>
<li><a class="tag p-category" href="../../../categories/thor.html" rel="tag">thor</a></li>
</ul>
<ul class="pager hidden-print">
<li class="previous">
<a href="new-hobby-project-thor-os-64bit-operating-system-c.html" rel="prev" title="New hobby project: Thor-OS, 64bit Operating System in C++">Previous post</a>
</li>
<li class="next">
<a href="zabbix-low-level-discovery-cores-cpus-hard-disk.html" rel="next" title="Zabbix - Low Level Discovery of cores, CPUs and Hard Disk">Next post</a>
</li>
</ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>

<div id="disqus_thread"></div>
<script>
        var disqus_shortname ="blogwichtounet",
            disqus_url="http://baptiste-wicht.com/posts/2013/12/thor-os-boot-process.html",
        disqus_title="Thor OS: Boot Process",
        disqus_identifier="cache/posts/2013/12/thor-os-boot-process.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
<a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>
</section></article><script>var disqus_shortname="blogwichtounet";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>
</div> 
</div>

</div>



<footer>
Contents Â© 2017 <a href="/cdn-cgi/l/email-protection#99fbf8e9edf0eaedfceef0faf1edd9fef4f8f0f5b7faf6f4">Baptiste Wicht</a> - Powered by <a href="http://getnikola.com" rel="nofollow">Nikola</a> - License:
<a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="padding-left:5px;border-width:0" src="../../../assets/img/cc.png"></a>
<ul class="footer_inline_ul">
<li>
<a href="thor-os-boot-process.wp" id="sourcelink">Source</a>
</li>
</ul></footer><script src="/cdn-cgi/scripts/78d64697/cloudflare-static/email-decode.min.js"></script><script src="../../../assets/js/all-nocdn.js"></script>
</body>
</html>
