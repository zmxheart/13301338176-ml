<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Develop a modular application - The loading | Blog blog("Baptiste Wicht");</title>
<script src="/cdn-cgi/apps/head/98vpnawSZZMscPn4oDND-ZgswjM.js"></script><link href="../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../../rss.xml">
<link rel="canonical" href="http://baptiste-wicht.com/posts/2010/05/modular-application-loading-modules.html">
<!--[if lt IE 9]><script src="../../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Baptiste Wicht">
<link rel="prev" href="develop-a-modular-application-implementation.html" title="Develop a modular application – Implementation" type="text/html">
<link rel="next" href="tip-add-resources-dynamically-to-a-classloader.html" title="Tip : Add resources dynamically to a ClassLoader" type="text/html">
<meta property="og:site_name" content='Blog blog("Baptiste Wicht");'>
<meta property="og:title" content="Develop a modular application - The loading">
<meta property="og:url" content="http://baptiste-wicht.com/posts/2010/05/modular-application-loading-modules.html">
<meta property="og:description" content="Now that we've seen how to describe a module in Java, we'll see how to load it dynamically in our application.
In Java, all the classes are loaded using several ClassLoader.In this article, we'll deve">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2010-05-14T06:33:40+02:00">
<meta property="article:tag" content="Conception">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="Modular">
<link href="../../../favicon.ico" rel="icon" type="image/x-icon">
<link rel="publisher" href="https://plus.google.com/+BaptisteWicht">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-2175227-7', 'auto');
  var metas = document.getElementsByTagName('meta'), tagsList = [];
  for (var i=0; i<metas.length; i++) {
    if (metas[i].getAttribute('property') == 'article:tag') {
      tagsList.push( metas[i].getAttribute('content'));
    }
  }
  ga('set', 'dimension1', tagsList.join('|'));
  ga('send', 'pageview');
</script>
</head>
<body>

<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
<div class="container-fluid">

<div class="row">
<div class="col-sm-3 col-lg-2">
<nav class="navbar navbar-inverse navbar-fixed-side"><div class="navbar-header">
<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
<span class="sr-only">Toggle navigation</span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
</button>
<a class="navbar-brand" href="http://baptiste-wicht.com/">
<span id="blog-title">Blog blog("Baptiste Wicht");</span>
</a>
</div>

<div class="collapse navbar-collapse navbar-ex1-collapse">
<ul class="nav navbar-nav">
<li>
<a href="../../../stories/about.html">About</a>
</li>
<li>
<a href="../../../stories/publications.html">Publications</a>
</li>
<li>
<a href="../../../stories/projects.html">Projects</a>
</li>
<li>
<a href="../../../categories/index.html">Tags</a>
</li>
<li>
<a href="../../../archive.html">Archives</a>
</li>
<li>
<a href="http://feeds.feedburner.com/BaptisteWicht">RSS</a>
</li>
<li class="navbar-content">
<h3>Related posts</h3>
</li>
<li><a href="develop-a-modular-application-implementation.html">Develop a modular application – Implementation</a></li>
<li><a href="modular-application-modules.html">Develop a modular application – The modules</a></li>
<li><a href="develop-a-modular-application-bases.html">Develop a modular application – Bases</a></li>
<li><a href="../02/modular-application-jtheque-core-2-0-3.html">Develop a modular application with JTheque Core 2.0.3</a></li>
<li><a href="tip-add-resources-dynamically-to-a-classloader.html">Tip : Add resources dynamically to a ClassLoader</a></li>
<li><a href="../07/modular-java-book-review.html">Modular Java – Book Review</a></li>
<li class="navbar-block">
<li class="wicht-navbar-right">
<a target="_blank" title="Follow @wichtounet on Twitter" href="https://twitter.com/wichtounet">
<img src="../../../assets/img/twitter.png" alt="Follow @wichtounet on Twitter"></a>
</li>
<li class="wicht-navbar-right">
<a target="_blank" title="Follow +BaptisteWicht on Google+" href="https://plus.google.com/+BaptisteWicht">
<img src="../../../assets/img/google_plus.png" alt="Follow +BaptisteWicht on Google+"></a>
</li>
</ul>
</div>

</nav>
</div> 
<div class="col-sm-9 col-lg-10">
<div id="content"></div>
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">Develop a modular application - The loading</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">
Baptiste Wicht
</span></p>
<p class="dateline"><a href="#" rel="bookmark"><time class="published dt-published" datetime="2010-05-14T06:33:40+02:00" itemprop="datePublished" title="2010-05-14 06:33">2010-05-14 06:33</time></a></p>
<p class="commentline">
<a href="modular-application-loading-modules.html#disqus_thread" data-disqus-identifier="cache/posts/2010/05/modular-application-loading-modules.html">Comments</a>
</p>
<p class="sourceline"><a href="modular-application-loading-modules.wp" class="sourcelink">Source</a></p>
</div>
</header><div class="e-content entry-content" itemprop="articleBody text">
<div>
<p>Now that we've seen <a href="http://www.baptiste-wicht.com/2010/05/develop-a-modular-application-implementation/">how to describe a module in Java</a>, we'll see how to load it dynamically in our application.</p>
<p>In Java, all the classes are loaded using several ClassLoader.In this article, we'll develop a loader for our modules and watch the problems that arrive when working with custom ClassLoaders.</p>

<p>Normally, Java use the system ClassLoader to load all the classes of our application. So it contains all the classes of our application and all the classes our application needs to work. But the problem is that we cannot add our modules jar files into classpath because the application doesn't know the modules jar files names.</p>
<p>Moreover, we cannot theoretically add files to the system ClassLoader. I say theoretically because, we can add files using reflection and call to a private method, but i thing it's not a really good practice.</p>
<p>So we've to create a new ClassLoader to load our modules. We'll do that in two phases :</p>
<ol>
<li>Browse the module files to get the classes of the modules and the URLs of the modules Jar files</li>
<li>Load the modules into our ClassLoader using the URLs of the first phase</li>
</ol>
<p>We'll do all the loading in a new class ModularLoader. so let's create a create a method that return the list of classes to load :</p>
<pre class="code literal-block"><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ModuleLoader</span> <span class="o">{</span> 
  <span class="kd">private</span> <span class="kd">static</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">URL</span><span class="o">&gt;</span> <span class="n">urls</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">URL</span><span class="o">&gt;();</span> 

  <span class="kd">private</span> <span class="kd">static</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">getModuleClasses</span><span class="o">(){</span> 
    <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">classes</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span> 

    <span class="c1">//Get all the modules of the modules folder</span>
    <span class="n">File</span><span class="o">[]</span> <span class="n">files</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">"folder"</span><span class="o">).</span><span class="na">listFiles</span><span class="o">(</span><span class="k">new</span> <span class="n">ModuleFilter</span><span class="o">());</span> 

    <span class="k">for</span><span class="o">(</span><span class="n">File</span> <span class="n">f</span> <span class="o">:</span> <span class="n">files</span><span class="o">){</span> 
      <span class="n">JarFile</span> <span class="n">jarFile</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span> 

      <span class="k">try</span> <span class="o">{</span> 
        <span class="c1">//Open the Jar File</span>
        <span class="n">jarFile</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JarFile</span><span class="o">(</span><span class="n">f</span><span class="o">);</span> 

        <span class="c1">//We get the manifest</span>
        <span class="n">Manifest</span> <span class="n">manifest</span> <span class="o">=</span> <span class="n">jarFile</span><span class="o">.</span><span class="na">getManifest</span><span class="o">();</span> 

        <span class="c1">//We get the class name from the manifest attributes</span>
        <span class="n">classes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">manifest</span><span class="o">.</span><span class="na">getMainAttributes</span><span class="o">().</span><span class="na">getValue</span><span class="o">(</span><span class="s">"Module-Class"</span><span class="o">));</span> 

        <span class="n">urls</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">f</span><span class="o">.</span><span class="na">toURI</span><span class="o">().</span><span class="na">toURL</span><span class="o">());</span> 
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span> 
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span> 
      <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span> 
        <span class="k">if</span><span class="o">(</span><span class="n">jarFile</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span> 
          <span class="k">try</span> <span class="o">{</span> 
            <span class="n">jarFile</span><span class="o">.</span><span class="na">close</span><span class="o">();</span> 
          <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span> 
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span> 
          <span class="o">}</span> 
        <span class="o">}</span> 
      <span class="o">}</span> 
    <span class="o">}</span> 

    <span class="k">return</span> <span class="n">classes</span><span class="o">;</span> 
  <span class="o">}</span> 

  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ModuleFilter</span> <span class="kd">implements</span> <span class="n">FileFilter</span> <span class="o">{</span> 
    <span class="nd">@Override</span> 
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">accept</span><span class="o">(</span><span class="n">File</span> <span class="n">file</span><span class="o">)</span> <span class="o">{</span> 
      <span class="k">return</span> <span class="n">file</span><span class="o">.</span><span class="na">isFile</span><span class="o">()</span> <span class="o">&amp;</span><span class="n">amp</span><span class="o">;&amp;</span><span class="n">amp</span><span class="o">;</span> <span class="n">file</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">toLowerCase</span><span class="o">().</span><span class="na">endsWith</span><span class="o">(</span><span class="s">".jar"</span><span class="o">);</span> 
    <span class="o">}</span> 
  <span class="o">}</span> 
<span class="o">}</span>
</pre>
<p>Like you see, it's not complicated at all. We search all the module files and then for each jar file, we open it, get the manifest et read the class name of the module. And then, for the second phase, we get the URL to the Jar file. </p>
<p>Of course, this loader is not perfect. We can have modules with no manifest or manifest with no class name and the errors must be correctly treated, but this is not the objective of this post to be perfect. </p>
<p>Now we can do the second phase, adding a method to create the ClassLoader, instantiate the modules and return them : </p>
<pre class="code literal-block"><span></span><span class="kd">private</span> <span class="kd">static</span> <span class="n">ClassLoader</span> <span class="n">classLoader</span><span class="o">;</span> 

<span class="kd">public</span> <span class="kd">static</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">IModule</span><span class="o">&gt;</span> <span class="nf">loadModules</span><span class="o">(){</span> 
  <span class="n">List</span><span class="o">&lt;</span><span class="n">IModule</span><span class="o">&gt;</span> <span class="n">modules</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">IModule</span><span class="o">&gt;();</span> 

  <span class="n">AccessController</span><span class="o">.</span><span class="na">doPrivileged</span><span class="o">(</span><span class="k">new</span> <span class="n">PrivilegedAction</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;(){</span> 
    <span class="nd">@Override</span> 
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span> 
      <span class="n">classLoader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">URLClassLoader</span><span class="o">(</span> 
          <span class="n">urls</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="k">new</span> <span class="n">URL</span><span class="o">[</span><span class="n">urls</span><span class="o">.</span><span class="na">size</span><span class="o">()]),</span>  
          <span class="n">ModuleLoader</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">());</span> 

      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span> 
    <span class="o">}</span> 
  <span class="o">});</span> 

  <span class="c1">//Load all the modules</span>
  <span class="k">for</span><span class="o">(</span><span class="n">String</span> <span class="n">c</span> <span class="o">:</span> <span class="n">getModuleClasses</span><span class="o">()){</span> 
    <span class="k">try</span> <span class="o">{</span> 
      <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">moduleClass</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="n">classLoader</span><span class="o">);</span> 

      <span class="k">if</span><span class="o">(</span><span class="n">IModule</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">moduleClass</span><span class="o">)){</span> 
        <span class="n">Class</span><span class="o">&lt;</span><span class="n">IModule</span><span class="o">&gt;</span> <span class="n">castedClass</span> <span class="o">=</span> <span class="o">(</span><span class="n">Class</span><span class="o">&lt;</span><span class="n">IModule</span><span class="o">&gt;)</span> <span class="n">moduleClass</span><span class="o">;</span> 

        <span class="n">IModule</span> <span class="n">module</span> <span class="o">=</span> <span class="n">castedClass</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span> 

        <span class="n">modules</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">module</span><span class="o">);</span> 
      <span class="o">}</span>  
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ClassNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span> 
      <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span> 
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InstantiationException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span> 
      <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span> 
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IllegalAccessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span> 
      <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span> 
    <span class="o">}</span> 
  <span class="o">}</span> 

  <span class="k">return</span> <span class="n">modules</span><span class="o">;</span> 
<span class="o">}</span>
</pre>
<p>So we start creating a new ClassLoader taking the urls of the Jar files. Then, we use this ClassLoader to load all the module classes and instantiate them. We only verify if the class is of type IModule. </p>
<p>This is all for our ModuleLoader. We can now test our simple modular application. We create a JAR file for the module of the previous post and then we create a very simple application to test that : </p>
<pre class="code literal-block"><span></span><span class="n">List</span><span class="o">&lt;</span><span class="n">IModule</span><span class="o">&gt;</span> <span class="n">modules</span> <span class="o">=</span> <span class="n">ModuleLoader</span><span class="o">.</span><span class="na">loadModules</span><span class="o">();</span> 

<span class="k">for</span><span class="o">(</span><span class="n">IModule</span> <span class="n">module</span> <span class="o">:</span> <span class="n">modules</span><span class="o">){</span> 
  <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Plug : "</span> <span class="o">+</span> <span class="n">module</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span> 
  <span class="n">module</span><span class="o">.</span><span class="na">plug</span><span class="o">();</span> 
<span class="o">}</span> 

<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Lot of other things done by the application. "</span><span class="o">);</span> 

<span class="k">for</span><span class="o">(</span><span class="n">IModule</span> <span class="n">module</span> <span class="o">:</span> <span class="n">modules</span><span class="o">){</span> 
  <span class="n">module</span><span class="o">.</span><span class="na">unplug</span><span class="o">();</span> 
<span class="o">}</span>
</pre>
<p>And here is the output of the application : </p>
<pre>Plug : Simple module
Hello kernel !
Lot of other things done by the application. 
Bye kernel !</pre>
<p>Like you can see, we just created a modular applications ! The application doesn't know the modules, but the modules can do things in the application. </p>
<p>Of course, to create a real applicatio, we have to develop all the extension points and services, but this is a base to start with. </p>
<p>However, there is some problems with the current implementations : </p>
<ul>
<li>We cannot deploy modules without restarting the application, because we must create a new ClassLoader for the modules. This is possible if there is no interation between modules, but that's not often the case. You have also the possibility to isolate all the modules in a specific ClassLoader, but with that second solution, the interations between modules are made harder. </li>
<li>Using a second ClassLoader may be problematic with libraries loading dynamically the classes like Spring or Hibernate. To make these libraries working with your ClassLoader, you have to look at case by case depending on the library. Often, you achieve specifying the contextClassLoader using the method Thread.currentThread().setContextClassLoader(ClassLoader cl) with your ClassLoader</li>
</ul>
<p>So here is the end of this four posts about creating a modular application. I hope you find these posts interesting.</p>
</div>
</div>
<aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../../categories/conception.html" rel="tag">Conception</a></li>
<li><a class="tag p-category" href="../../../categories/java.html" rel="tag">Java</a></li>
<li><a class="tag p-category" href="../../../categories/modular.html" rel="tag">Modular</a></li>
</ul>
<ul class="pager hidden-print">
<li class="previous">
<a href="develop-a-modular-application-implementation.html" rel="prev" title="Develop a modular application – Implementation">Previous post</a>
</li>
<li class="next">
<a href="tip-add-resources-dynamically-to-a-classloader.html" rel="next" title="Tip : Add resources dynamically to a ClassLoader">Next post</a>
</li>
</ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
<div id="disqus_thread"></div>
<script>
        var disqus_shortname ="blogwichtounet",
            disqus_url="http://baptiste-wicht.com/posts/2010/05/modular-application-loading-modules.html",
        disqus_title="Develop a modular application - The loading",
        disqus_identifier="cache/posts/2010/05/modular-application-loading-modules.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
<a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>
</section></article><script>var disqus_shortname="blogwichtounet";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>
</div> 
</div>

</div>



<footer>
Contents © 2017 <a href="/cdn-cgi/l/email-protection#46242736322f353223312f252e3206212b272f2a6825292b">Baptiste Wicht</a> - Powered by <a href="http://getnikola.com" rel="nofollow">Nikola</a> - License:
<a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="padding-left:5px;border-width:0" src="../../../assets/img/cc.png"></a>
<ul class="footer_inline_ul">
<li>
<a href="modular-application-loading-modules.wp" id="sourcelink">Source</a>
</li>
</ul></footer><script src="/cdn-cgi/scripts/78d64697/cloudflare-static/email-decode.min.js"></script><script src="../../../assets/js/all-nocdn.js"></script>
</body>
</html>
