<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Java Concurrency - Part 5 : Monitors (Locks and Conditions) | Blog blog("Baptiste Wicht");</title>
<script src="/cdn-cgi/apps/head/98vpnawSZZMscPn4oDND-ZgswjM.js"></script><link href="../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../../rss.xml">
<link rel="canonical" href="http://baptiste-wicht.com/posts/2010/09/java-concurrency-part-5-monitors-locks-and-conditions.html">
<!--[if lt IE 9]><script src="../../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Baptiste Wicht">
<link rel="prev" href="save-time-with-the-gmail-priority-inbox.html" title="Save time with the Gmail Priority Inbox" type="text/html">
<link rel="next" href="java-concurrency-atomic-variables.html" title="Java Concurrency - Part 6 : Atomic Variables" type="text/html">
<meta property="og:site_name" content='Blog blog("Baptiste Wicht");'>
<meta property="og:title" content="Java Concurrency - Part 5 : Monitors (Locks and Conditions)">
<meta property="og:url" content="http://baptiste-wicht.com/posts/2010/09/java-concurrency-part-5-monitors-locks-and-conditions.html">
<meta property="og:description" content="After seeing how to synchronize code using semaphores, we'll see how to do that using monitors.
Monitors are an other mechanism of concurrent programming. It's a higher level mechanism than semaphores">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2010-09-06T07:13:27+02:00">
<meta property="article:tag" content="Concurrency">
<meta property="article:tag" content="Java">
<link href="../../../favicon.ico" rel="icon" type="image/x-icon">
<link rel="publisher" href="https://plus.google.com/+BaptisteWicht">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-2175227-7', 'auto');
  var metas = document.getElementsByTagName('meta'), tagsList = [];
  for (var i=0; i<metas.length; i++) {
    if (metas[i].getAttribute('property') == 'article:tag') {
      tagsList.push( metas[i].getAttribute('content'));
    }
  }
  ga('set', 'dimension1', tagsList.join('|'));
  ga('send', 'pageview');
</script>
</head>
<body>

<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
<div class="container-fluid">

<div class="row">
<div class="col-sm-3 col-lg-2">
<nav class="navbar navbar-inverse navbar-fixed-side"><div class="navbar-header">
<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
<span class="sr-only">Toggle navigation</span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
</button>
<a class="navbar-brand" href="http://baptiste-wicht.com/">
<span id="blog-title">Blog blog("Baptiste Wicht");</span>
</a>
</div>

<div class="collapse navbar-collapse navbar-ex1-collapse">
<ul class="nav navbar-nav">
<li>
<a href="../../../stories/about.html">About</a>
</li>
<li>
<a href="../../../stories/publications.html">Publications</a>
</li>
<li>
<a href="../../../stories/projects.html">Projects</a>
</li>
<li>
<a href="../../../categories/index.html">Tags</a>
</li>
<li>
<a href="../../../archive.html">Archives</a>
</li>
<li>
<a href="http://feeds.feedburner.com/BaptisteWicht">RSS</a>
</li>
<li class="navbar-content">
<h3>Related posts</h3>
</li>
<li><a href="../06/monitor-programming-in-jr.html">Monitor programming in JR</a></li>
<li><a href="../../2012/04/c11-concurrency-tutorial-advanced-locking-and-condition-variables.html">C++11 Concurrency Tutorial - Part 3: Advanced locking and condition variables</a></li>
<li><a href="../08/java-concurrrency-synchronization-locks.html">Java Concurrency – Part 3 : Synchronization with intrinsic locks</a></li>
<li><a href="java-synchronization-mutual-exclusion-benchmark.html">Java Synchronization (Mutual Exclusion) Benchmark</a></li>
<li><a href="../../2012/03/cp11-concurrency-tutorial-part-2-protect-shared-data.html">C++11 Concurrency Tutorial - Part 2 : Protect shared data</a></li>
<li><a href="../06/how-to-choose-a-monitor.html">How to choose a monitor for your computer ? </a></li>
<li class="navbar-block">
<li class="wicht-navbar-right">
<a target="_blank" title="Follow @wichtounet on Twitter" href="https://twitter.com/wichtounet">
<img src="../../../assets/img/twitter.png" alt="Follow @wichtounet on Twitter"></a>
</li>
<li class="wicht-navbar-right">
<a target="_blank" title="Follow +BaptisteWicht on Google+" href="https://plus.google.com/+BaptisteWicht">
<img src="../../../assets/img/google_plus.png" alt="Follow +BaptisteWicht on Google+"></a>
</li>
</ul>
</div>

</nav>
</div> 
<div class="col-sm-9 col-lg-10">
<div id="content"></div>
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">Java Concurrency - Part 5 : Monitors (Locks and Conditions)</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">
Baptiste Wicht
</span></p>
<p class="dateline"><a href="#" rel="bookmark"><time class="published dt-published" datetime="2010-09-06T07:13:27+02:00" itemprop="datePublished" title="2010-09-06 07:13">2010-09-06 07:13</time></a></p>
<p class="commentline">
<a href="java-concurrency-part-5-monitors-locks-and-conditions.html#disqus_thread" data-disqus-identifier="cache/posts/2010/09/java-concurrency-part-5-monitors-locks-and-conditions.html">Comments</a>
</p>
<p class="sourceline"><a href="java-concurrency-part-5-monitors-locks-and-conditions.wp" class="sourcelink">Source</a></p>
</div>
</header><div class="e-content entry-content" itemprop="articleBody text">
<div>
<p>After seeing <a title="Java Concurrency – Part 4 : Semaphores" href="http://www.baptiste-wicht.com/2010/08/java-concurrency-part-4-semaphores/" target="_blank">how to synchronize code using semaphores</a>, we'll see how to do that using <strong>monitors</strong>.</p>
<p>Monitors are an other mechanism of concurrent programming. It's a higher level mechanism than semaphores and also more powerful. A monitor is an instance of a class that can be used safely by several threads. All the methods of a monitor are executed with mutual exclusion. So at most one thread can execute a method of the monitor at the same time. This mutual exclusion policy makes easier to work with monitor and to develop the method content of the monitor.</p>
<p>Monitors have an other feature, the possibility to make a thread waiting for a condition. During the wait time, the thread temporarily gives up its exclusive access and must reacquire it after the condition has been met. You can also signal one or more threads that a condition has been met.</p>
<p>There is several advantages on using monitors instead of a lower-level mechanisms :</p>
<ul>
<li>All the synchronization code is centralized in one location and the users of this code don’t need to know how it’s implemented.</li>
<li>The code doesn't depend on the number of processes, it works for as many processes as you want</li>
<li>You don’t need to release something like a mutex, so you cannot forget to do it</li>
</ul>
<p>When we must describe a monitor, we simple use the <strong>monitor</strong> keyword and describe the methods as common methods :</p>
<pre class="code literal-block"><span></span><span class="n">monitor</span> <span class="n">SimpleMonitor</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="n">method</span> <span class="kt">void</span> <span class="nf">testA</span><span class="o">(){</span>
        <span class="c1">//Some code</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">method</span> <span class="kt">int</span> <span class="nf">testB</span><span class="o">(){</span>
        <span class="k">return</span> <span class="mi">1</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre>
<p>To describe a condition variable, we use the <strong>cond</strong> keyword. A condition variable is a kind of queue of process who are waiting on the same condition. You have several operations available on a condition, the most important is to signal a process waiting to be awaken and to wait on a condition. There are some similarities between signal/wait operations and P and V of semaphores, but this is a little different. The signal operation does nothing if the queue is empty and the wait operation put always the thread in the waiting queue. The process queue is served in a first come, first served mode. When a thread wakes up after waiting on a condition, it must reacquire the lock before continuing in the code.</p>
<p>Before going further, we must have more information about the signal operations. When writing monitors, you normally have the choice between several philosophies for the signaling operation :</p>
<ol>
<li>Signal &amp; Continue (SC) : The process who signal keep the mutual exclusion and the signaled will be awaken but need to acquire the mutual exclusion before going.</li>
<li>Signal &amp; Wait (SW) : The signaler is blocked and must wait for mutual exclusion to continue and the signaled thread is directly awaken and can start continue its operations.</li>
<li>Signal &amp; Urgent Wait (SU) : Like SW but the signaler thread has the guarantee than it would go just after the signaled thread</li>
<li>Signal &amp; Exit (SX) : The signaler exits from the method directly after the signal and the signaled thread can start directly. This philosophy is not often used.</li>
</ol>
<p>The available policies depends on the programming language, in Java, there is only one policy available, the SC one.</p>
<p>In Java there is no keyword to directly create a monitor. To implement a monitor, you must create a new class and use <strong>Lock</strong> and <strong>Condition</strong> classes. Lock is the interface is <strong>ReentrantLock</strong> is the main used implementation, this is the one that we'll learn to use in the current post. To create a ReentrantLock, you have two constructors, a default constructor and a constructor with a boolean argument indicating if the lock is fair or not. A fair lock indicates that the threads will acquire the locks in the order they ask for. Fairness is a little heavier than default locking strategies, so use it only if you need it. To acquire the lock, you just have to use the method <em>lock</em> and <em>unlock</em> to release it.</p>
<p>The explicit locks have the same memory semantics than the synchronized blocks. So the visibility of the changes is guarantee when you use lock()/unlock() blocks.</p>
<p>So to implement, the monitor example we've seen before, we just need to create a class and use the lock to make the mutual exclusion :</p>
<pre class="code literal-block"><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimpleMonitor</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Lock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReentrantLock</span><span class="o">();</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testA</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">//Some code</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">testB</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="k">return</span> <span class="mi">1</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre>
<p>The person who've already read the other parts of this post set will say that it will be easier to use the synchronized keyword on the two methods. But with synchronized, we will not have the condition variables. If you don't need condition variables but only locking, it will be easier to use the synchronized blocks instead of Locks.</p>
<p>You can create conditions using the <em>newCondition</em> method on the lock. A condition is a variable of type <strong>Condition</strong>. You can make the current thread wait on the condition using the <em>await</em> method (and its variant with timeout) and you can signal threads using <em>signal</em> and <em>signalAll</em> methods. The signalAll methods wakes up all the threads waiting on the condition variable.</p>
<p>Let's try with a simple common example : A bounded buffer. It's a cyclic buffer with a certain capacity with a start and an end.</p>
<pre class="code literal-block"><span></span><span class="kn">import</span> <span class="nn">java.util.concurrent.locks.Condition</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.Lock</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.ReentrantLock</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BoundedBuffer</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span><span class="o">[]</span> <span class="n">buffer</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">capacity</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">front</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">rear</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">count</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Lock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReentrantLock</span><span class="o">();</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Condition</span> <span class="n">notFull</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="na">newCondition</span><span class="o">();</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Condition</span> <span class="n">notEmpty</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="na">newCondition</span><span class="o">();</span>

    <span class="kd">public</span> <span class="nf">BoundedBuffer</span><span class="o">(</span><span class="kt">int</span> <span class="n">capacity</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">();</span>

        <span class="k">this</span><span class="o">.</span><span class="na">capacity</span> <span class="o">=</span> <span class="n">capacity</span><span class="o">;</span>

        <span class="n">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">[</span><span class="n">capacity</span><span class="o">];</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">deposit</span><span class="o">(</span><span class="n">String</span> <span class="n">data</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
        <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">count</span> <span class="o">==</span> <span class="n">capacity</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">notFull</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
            <span class="o">}</span>

            <span class="n">buffer</span><span class="o">[</span><span class="n">rear</span><span class="o">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">;</span>
            <span class="n">rear</span> <span class="o">=</span> <span class="o">(</span><span class="n">rear</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">%</span> <span class="n">capacity</span><span class="o">;</span>
            <span class="n">count</span><span class="o">++;</span>

            <span class="n">notEmpty</span><span class="o">.</span><span class="na">signal</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">fetch</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
        <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">notEmpty</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
            <span class="o">}</span>

            <span class="n">String</span> <span class="n">result</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">[</span><span class="n">front</span><span class="o">];</span>
            <span class="n">front</span> <span class="o">=</span> <span class="o">(</span><span class="n">front</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">%</span> <span class="n">capacity</span><span class="o">;</span>
            <span class="n">count</span><span class="o">--;</span>

            <span class="n">notFull</span><span class="o">.</span><span class="na">signal</span><span class="o">();</span>

            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre>
<p>So some explications :</p>
<ol>
<li>The two methods are protected with the lock to ensure mutual exclusion</li>
<li>Then we use two conditions variables. One to wait for the buffer to be not empty and an other one to wait for the buffer to be not full.</li>
<li>You can see that I have wrapped the await operation on a while loop. This is to avoid signal stealers problem that can occurs when using Signal &amp; Continue</li>
</ol>
<p>And that BoundedBuffer can be easily used with several threads with no problems.</p>
<p>As you can see, you can use monitors to solve a lot of concurrent programming problems and this mechanism is really powerful and performing.</p>
<p>I hope you found that article interesting and that this set of posts about Java concurrency brings you some stuff about Java.</p>
</div>
</div>
<aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../../categories/concurrency.html" rel="tag">Concurrency</a></li>
<li><a class="tag p-category" href="../../../categories/java.html" rel="tag">Java</a></li>
</ul>
<ul class="pager hidden-print">
<li class="previous">
<a href="save-time-with-the-gmail-priority-inbox.html" rel="prev" title="Save time with the Gmail Priority Inbox">Previous post</a>
</li>
<li class="next">
<a href="java-concurrency-atomic-variables.html" rel="next" title="Java Concurrency - Part 6 : Atomic Variables">Next post</a>
</li>
</ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
<div id="disqus_thread"></div>
<script>
        var disqus_shortname ="blogwichtounet",
            disqus_url="http://baptiste-wicht.com/posts/2010/09/java-concurrency-part-5-monitors-locks-and-conditions.html",
        disqus_title="Java Concurrency - Part 5 : Monitors (Locks and Conditions)",
        disqus_identifier="cache/posts/2010/09/java-concurrency-part-5-monitors-locks-and-conditions.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
<a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>
</section></article><script>var disqus_shortname="blogwichtounet";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>
</div> 
</div>

</div>



<footer>
Contents © 2017  <a href="/cdn-cgi/l/email-protection#13717263677a606776647a707b6753747e727a7f3d707c7e">Baptiste Wicht</a> - Powered by <a href="http://getnikola.com" rel="nofollow">Nikola</a> - License:
<a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="padding-left:5px;border-width:0" src="../../../assets/img/cc.png"></a>
<ul class="footer_inline_ul">
<li>
<a href="java-concurrency-part-5-monitors-locks-and-conditions.wp" id="sourcelink">Source</a>
</li>
</ul></footer><script src="/cdn-cgi/scripts/78d64697/cloudflare-static/email-decode.min.js"></script><script src="../../../assets/js/all-nocdn.js"></script>
</body>
</html>
