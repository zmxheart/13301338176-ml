<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>C++17 Fold Expressions | Blog blog("Baptiste Wicht");</title>
<script src="/cdn-cgi/apps/head/98vpnawSZZMscPn4oDND-ZgswjM.js"></script><link href="../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../../rss.xml">
<link rel="canonical" href="http://baptiste-wicht.com/posts/2015/05/cpp17-fold-expressions.html">
<!--[if lt IE 9]><script src="../../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Baptiste Wicht">
<link rel="prev" href="sonar-cpp-community-plugin-review.html" title="Sonar C++ Community Plugin Review" type="text/html">
<link rel="next" href="../06/continuous-performance-management-with-cpm-for-cpp.html" title="Continuous Performance Management with CPM for C++" type="text/html">
<meta property="og:site_name" content='Blog blog("Baptiste Wicht");'>
<meta property="og:title" content="C++17 Fold Expressions">
<meta property="og:url" content="http://baptiste-wicht.com/posts/2015/05/cpp17-fold-expressions.html">
<meta property="og:description" content="Variadic Templates
C++11 introduced variadic template to the languages. This new feature allows to write template functions and classes taking an arbitrary number of template parameters. This a featur">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2015-05-23T19:08:20+02:00">
<meta property="article:tag" content="C++">
<meta property="article:tag" content="C++17">
<link href="../../../favicon.ico" rel="icon" type="image/x-icon">
<link rel="publisher" href="https://plus.google.com/+BaptisteWicht">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-2175227-7', 'auto');
  var metas = document.getElementsByTagName('meta'), tagsList = [];
  for (var i=0; i<metas.length; i++) {
    if (metas[i].getAttribute('property') == 'article:tag') {
      tagsList.push( metas[i].getAttribute('content'));
    }
  }
  ga('set', 'dimension1', tagsList.join('|'));
  ga('send', 'pageview');
</script>
</head>
<body>

<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
<div class="container-fluid">

<div class="row">
<div class="col-sm-3 col-lg-2">
<nav class="navbar navbar-inverse navbar-fixed-side"><div class="navbar-header">
<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
<span class="sr-only">Toggle navigation</span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
</button>
<a class="navbar-brand" href="http://baptiste-wicht.com/">
<span id="blog-title">Blog blog("Baptiste Wicht");</span>
</a>
</div>

<div class="collapse navbar-collapse navbar-ex1-collapse">
<ul class="nav navbar-nav">
<li>
<a href="../../../stories/about.html">About</a>
</li>
<li>
<a href="../../../stories/publications.html">Publications</a>
</li>
<li>
<a href="../../../stories/projects.html">Projects</a>
</li>
<li>
<a href="../../../categories/index.html">Tags</a>
</li>
<li>
<a href="../../../archive.html">Archives</a>
</li>
<li>
<a href="http://feeds.feedburner.com/BaptisteWicht">RSS</a>
 </li>
<li class="navbar-content">
<h3>Related posts</h3>
</li>
<li><a href="../03/named-optional-template-parameters-compile-time.html">Named Optional Template parameters to configure a class at compile-time</a></li>
<li><a href="../07/simulate-static_if-with-c11c14.html">Simulate static_if with C++11/C++14</a></li>
<li><a href="../../2017/08/simplify-your-type-traits-with-c++14-variable-templates.html">Simplify your type traits with C++14 variable templates</a></li>
<li><a href="../../2016/12/cpp-compiler-benchmark-on-expression-templates-library-etl.html">C++ Compiler benchmark on Expression Templates Library (ETL)</a></li>
<li><a href="../../2016/12/pvs-studio-on-cpp-library-review.html">PVS-Studio on C++ Library Review</a></li>
<li><a href="../../2016/02/use-templight-and-templar-to-debug-cpp-templates.html">Use templight and Templar to debug C++ templates</a></li>
<li class="navbar-block">
<li class="wicht-navbar-right">
<a target="_blank" title="Follow @wichtounet on Twitter" href="https://twitter.com/wichtounet">
<img src="../../../assets/img/twitter.png" alt="Follow @wichtounet on Twitter"></a>
</li>
<li class="wicht-navbar-right">
<a target="_blank" title="Follow +BaptisteWicht on Google+" href="https://plus.google.com/+BaptisteWicht">
<img src="../../../assets/img/google_plus.png" alt="Follow +BaptisteWicht on Google+"></a>
</li>
</ul>
</div>

</nav>
</div> 
<div class="col-sm-9 col-lg-10">
<div id="content"></div>
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">C++17 Fold Expressions</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">
Baptiste Wicht
</span></p>
<p class="dateline"><a href="#" rel="bookmark"><time class="published dt-published" datetime="2015-05-23T19:08:20+02:00" itemprop="datePublished" title="2015-05-23 19:08">2015-05-23 19:08</time></a></p>
<p class="commentline">
<a href="cpp17-fold-expressions.html#disqus_thread" data-disqus-identifier="cache/posts/2015/05/cpp17-fold-expressions.html">Comments</a>
</p>
<p class="sourceline"><a href="cpp17-fold-expressions.rst" class="sourcelink">Source</a></p>
</div>
</header><div class="e-content entry-content" itemprop="articleBody text">
<div>
<div class="section" id="variadic-templates">
<h2>Variadic Templates</h2>
<p>C++11 introduced variadic template to the languages. This new feature allows to write template functions and classes taking an arbitrary number of template parameters. This a feature I really like and I already used it quite a lot in my different libraries. Here is a very simple example computing the sum of the parameters:</p>
<pre class="code c++"><a name="rest_code_e10658c1f4174ddcb10fb29de1ad39a4-1"></a><span class="k">auto</span> <span class="nf">old_sum</span><span class="p">(){</span>
<a name="rest_code_e10658c1f4174ddcb10fb29de1ad39a4-2"></a>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<a name="rest_code_e10658c1f4174ddcb10fb29de1ad39a4-3"></a><span class="p">}</span>
<a name="rest_code_e10658c1f4174ddcb10fb29de1ad39a4-4"></a>
<a name="rest_code_e10658c1f4174ddcb10fb29de1ad39a4-5"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T1</span><span class="p">,</span> <span class="k">typename</span><span class="p">...</span> <span class="n">T</span><span class="o">&gt;</span>
<a name="rest_code_e10658c1f4174ddcb10fb29de1ad39a4-6"></a><span class="k">auto</span> <span class="n">old_sum</span><span class="p">(</span><span class="n">T1</span> <span class="n">s</span><span class="p">,</span> <span class="n">T</span><span class="p">...</span> <span class="n">ts</span><span class="p">){</span>
<a name="rest_code_e10658c1f4174ddcb10fb29de1ad39a4-7"></a>    <span class="k">return</span> <span class="n">s</span> <span class="o">+</span> <span class="n">old_sum</span><span class="p">(</span><span class="n">ts</span><span class="p">...);;</span>
<a name="rest_code_e10658c1f4174ddcb10fb29de1ad39a4-8"></a><span class="p">}</span>
</pre>
<p>What can be seen here is a typical use of variadic templates. Almost all the time, is is necessary to use recursion and several functions to unpack the parameters and process them. There is only one way to unpack the arguments, by using the ... operator that simply put comma between arguments. Even if it works well, it is a bit heavy on the code. This will likely be completely optimized to a series of addition by the compiler, but it may still happen in more complicated functions that this is not done. Moreover, the intent is not always clear with that.</p>
<p>That is why C++17 introduced an extension for the variadic template, fold expressions.</p>
</div>
<div class="section" id="fold-expressions">
<h2>Fold expressions</h2>
<p>Fold expressions are a new way to unpack variadic parameters with operators. For now, only Clang 3.6 supports C++17 fold expression, with the -std=c++1z flag. That is the compiler I used to validate the examples of this post.</p>
<p>The syntax is bit disturbing at first but quite logical:</p>
<pre class="code c++"><a name="rest_code_64f1f8a94045401ebf16973662eadd99-1"></a><span class="p">(</span> <span class="n">pack</span> <span class="n">op</span> <span class="p">...</span> <span class="p">)</span>             <span class="c1">//(1)</span>
<a name="rest_code_64f1f8a94045401ebf16973662eadd99-2"></a><span class="p">(</span> <span class="p">...</span> <span class="n">op</span> <span class="n">pack</span> <span class="p">)</span>             <span class="c1">//(2)</span>
<a name="rest_code_64f1f8a94045401ebf16973662eadd99-3"></a><span class="p">(</span> <span class="n">pack</span> <span class="n">op</span> <span class="p">...</span> <span class="n">op</span> <span class="n">init</span> <span class="p">)</span>     <span class="c1">//(3)</span>
<a name="rest_code_64f1f8a94045401ebf16973662eadd99-4"></a><span class="p">(</span> <span class="n">init</span> <span class="n">op</span> <span class="p">...</span> <span class="n">op</span> <span class="n">pack</span> <span class="p">)</span>     <span class="c1">//(4)</span>
</pre>
<p>Where <em>pack</em> is an unexpanded parameter pack, <em>op</em> an operator and <em>init</em> a value. The version (1) is a right fold that is expanded like (P1 op (P2 op (P3 ... (PN-1 op PN)))). The version (2) is a left fold where the expansion is taken from the left. The (3) and (4) versions are almost the value except for an init value. Only some operators (+,*,&amp;,|,&amp;&amp;,||, ,) have defined init values and can be used with the versions (1) and (2). The other operators can only be used with an init value.</p>
<p>For instance, here is how we could write the sum functions with fold expressions:</p>
<pre class="code c++"><a name="rest_code_8193150aa1944b18b273b0ff88cf2ab4-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="p">...</span> <span class="n">T</span><span class="o">&gt;</span>
<a name="rest_code_8193150aa1944b18b273b0ff88cf2ab4-2"></a><span class="k">auto</span> <span class="n">fold_sum_1</span><span class="p">(</span><span class="n">T</span><span class="p">...</span> <span class="n">s</span><span class="p">){</span>
<a name="rest_code_8193150aa1944b18b273b0ff88cf2ab4-3"></a>    <span class="k">return</span> <span class="p">(...</span> <span class="o">+</span> <span class="n">s</span><span class="p">);</span>
<a name="rest_code_8193150aa1944b18b273b0ff88cf2ab4-4"></a><span class="p">}</span>
</pre>
<p>I personally think it is much better, it clearly states our intent and does not need recursion. By default, the init value used for addition is 0, but you can change it:</p>
<pre class="code c++"><a name="rest_code_de4c5ad05b7941ebaf349b4f9c1b79b2-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="p">...</span> <span class="n">T</span><span class="o">&gt;</span>
<a name="rest_code_de4c5ad05b7941ebaf349b4f9c1b79b2-2"></a><span class="k">auto</span> <span class="n">fold_sum_2</span><span class="p">(</span><span class="n">T</span><span class="p">...</span> <span class="n">s</span><span class="p">){</span>
<a name="rest_code_de4c5ad05b7941ebaf349b4f9c1b79b2-3"></a>    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">...</span> <span class="o">+</span> <span class="n">s</span><span class="p">);</span>
<a name="rest_code_de4c5ad05b7941ebaf349b4f9c1b79b2-4"></a><span class="p">}</span>
</pre>
<p>This will yield the sum of the elements plus one.</p>
<p>This can be also very practical to print some elements for instance:</p>
<pre class="code c++"><a name="rest_code_2dc091ce8f3e4cb9a1e027b77c72f936-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="p">...</span><span class="n">Args</span><span class="o">&gt;</span>
<a name="rest_code_2dc091ce8f3e4cb9a1e027b77c72f936-2"></a><span class="kt">void</span> <span class="n">print_1</span><span class="p">(</span><span class="n">Args</span><span class="o">&amp;&amp;</span><span class="p">...</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
<a name="rest_code_2dc091ce8f3e4cb9a1e027b77c72f936-3"></a>    <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="p">...</span> <span class="o">&lt;&lt;</span> <span class="n">args</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="sc">'\n'</span><span class="p">;</span>
<a name="rest_code_2dc091ce8f3e4cb9a1e027b77c72f936-4"></a><span class="p">}</span>
</pre>
<p>And this can even be used when doing Template Metaprogramming, for instance here is a TMP version of the and operator:</p>
<pre class="code c++"><a name="rest_code_ac5979a995c242ee9ea77793ed0f21ee-1"></a><span class="k">template</span><span class="o">&lt;</span><span class="kt">bool</span><span class="p">...</span> <span class="n">B</span><span class="o">&gt;</span>
<a name="rest_code_ac5979a995c242ee9ea77793ed0f21ee-2"></a><span class="k">struct</span> <span class="nl">fold_and</span> <span class="p">:</span> <span class="n">std</span><span class="o">::</span><span class="n">integral_constant</span><span class="o">&lt;</span><span class="kt">bool</span><span class="p">,</span> <span class="p">(</span><span class="n">B</span> <span class="o">&amp;&amp;</span> <span class="p">...)</span><span class="o">&gt;</span> <span class="p">{};</span>
</pre>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>C++17 fold expressions are a really nice additions to the language that makes working with variadic templates much easier. This already makes me wish for C++17 release :)</p>
<p>The source code for the examples are available on Github: <a class="reference external" href="https://github.com/wichtounet/articles/blob/master/src/fold_expressions.cpp">https://github.com/wichtounet/articles/blob/master/src/fold_expressions.cpp</a></p>
</div>
</div>
</div>
<aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../../categories/c%2B%2B.html" rel="tag">C++</a></li>
<li><a class="tag p-category" href="../../../categories/c%2B%2B17.html" rel="tag">C++17</a></li>
</ul>
<ul class="pager hidden-print">
<li class="previous">
<a href="sonar-cpp-community-plugin-review.html" rel="prev" title="Sonar C++ Community Plugin Review">Previous post</a>
</li>
<li class="next">
<a href="../06/continuous-performance-management-with-cpm-for-cpp.html" rel="next" title="Continuous Performance Management with CPM for C++">Next post</a>
</li>
</ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
<div id="disqus_thread"></div>
<script>
        var disqus_shortname ="blogwichtounet",
            disqus_url="http://baptiste-wicht.com/posts/2015/05/cpp17-fold-expressions.html",
        disqus_title="C++17 Fold Expressions",
        disqus_identifier="cache/posts/2015/05/cpp17-fold-expressions.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
<a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>
</section></article><script>var disqus_shortname="blogwichtounet";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>
</div> 
</div>

</div>



<footer>
Contents Â© 2017 <a href="/cdn-cgi/l/email-protection#77151607031e040312001e141f0337101a161e1b5914181a">Baptiste Wicht</a> - Powered by <a href="http://getnikola.com" rel="nofollow">Nikola</a> - License:
<a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="padding-left:5px;border-width:0" src="../../../assets/img/cc.png"></a>
<ul class="footer_inline_ul">
<li>
<a href="cpp17-fold-expressions.rst" id="sourcelink">Source</a>
</li>
</ul></footer><script src="/cdn-cgi/scripts/78d64697/cloudflare-static/email-decode.min.js"></script><script src="../../../assets/js/all-nocdn.js"></script>
</body>
</html>
