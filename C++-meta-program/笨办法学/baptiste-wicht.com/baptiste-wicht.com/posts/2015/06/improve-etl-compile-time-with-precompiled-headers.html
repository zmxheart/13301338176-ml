<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Improve ETL compile-time with Precompiled Headers | Blog blog("Baptiste Wicht");</title>
<script src="/cdn-cgi/apps/head/98vpnawSZZMscPn4oDND-ZgswjM.js"></script><link href="../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../../rss.xml">
<link rel="canonical" href="http://baptiste-wicht.com/posts/2015/06/improve-etl-compile-time-with-precompiled-headers.html">
<!--[if lt IE 9]><script src="../../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Baptiste Wicht">
<link rel="prev" href="how-i-improved-a-bit-compile-time-of-etl.html" title="How I improved (a bit) compile time of ETL ?" type="text/html">
<link rel="next" href="../07/simulate-static_if-with-c11c14.html" title="Simulate static_if with C++11/C++14" type="text/html">
<meta property="og:site_name" content='Blog blog("Baptiste Wicht");'>
<meta property="og:title" content="Improve ETL compile-time with Precompiled Headers">
<meta property="og:url" content="http://baptiste-wicht.com/posts/2015/06/improve-etl-compile-time-with-precompiled-headers.html">
<meta property="og:description" content="Very recently, I started trying to improve the compile-time of the ETL test suite. While not critical, it is always better to have tests that compile as fast as possible. In a previous post, I was abl">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2015-06-20T15:08:31+02:00">
<meta property="article:tag" content="C++">
<meta property="article:tag" content="Compilers">
<meta property="article:tag" content="etl">
<meta property="article:tag" content="gcc">
<meta property="article:tag" content="Performances">
<link href="../../../favicon.ico" rel="icon" type="image/x-icon">
<link rel="publisher" href="https://plus.google.com/+BaptisteWicht">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-2175227-7', 'auto');
  var metas = document.getElementsByTagName('meta'), tagsList = [];
  for (var i=0; i<metas.length; i++) {
    if (metas[i].getAttribute('property') == 'article:tag') {
      tagsList.push( metas[i].getAttribute('content'));
    }
  }
  ga('set', 'dimension1', tagsList.join('|'));
  ga('send', 'pageview');
</script>
</head>
<body>

<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
<div class="container-fluid">

<div class="row">
<div class="col-sm-3 col-lg-2">
<nav class="navbar navbar-inverse navbar-fixed-side"><div class="navbar-header">
<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
<span class="sr-only">Toggle navigation</span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
</button>
<a class="navbar-brand" href="http://baptiste-wicht.com/">
<span id="blog-title">Blog blog("Baptiste Wicht");</span>
</a>
</div>

<div class="collapse navbar-collapse navbar-ex1-collapse">
<ul class="nav navbar-nav">
<li>
<a href="../../../stories/about.html">About</a>
</li>
<li>
<a href="../../../stories/publications.html">Publications</a>
</li>
<li>
<a href="../../../stories/projects.html">Projects</a>
 </li>
<li>
<a href="../../../categories/index.html">Tags</a>
</li>
<li>
<a href="../../../archive.html">Archives</a>
</li>
<li>
<a href="http://feeds.feedburner.com/BaptisteWicht">RSS</a>
</li>
<li class="navbar-content">
<h3>Related posts</h3>
</li>
<li><a href="how-i-improved-a-bit-compile-time-of-etl.html">How I improved (a bit) compile time of ETL ?</a></li>
<li><a href="../../2016/01/improve-dll-and-etl-compile-time-further.html">Improve DLL and ETL Compile Time further</a></li>
<li><a href="../../2017/05/speed-up-tensorflow-inference-compiling-from-source.html">Speed up TensorFlow inference by compiling it from source</a></li>
<li><a href="../../2014/07/catch-powerful-yet-simple-cpp-test-framework.html">Catch: A powerful yet simple C++ test framework</a></li>
<li><a href="../../2016/09/expression-templates-library-etl-10.html">Expression Templates Library (ETL) 1.0</a></li>
<li><a href="../../2014/10/sonarqube-inspections-for-cpp-projects.html">SonarQube inspections for C++ projects</a></li>
<li class="navbar-block">
<li class="wicht-navbar-right">
<a target="_blank" title="Follow @wichtounet on Twitter" href="https://twitter.com/wichtounet">
<img src="../../../assets/img/twitter.png" alt="Follow @wichtounet on Twitter"></a>
</li>
<li class="wicht-navbar-right">
<a target="_blank" title="Follow +BaptisteWicht on Google+" href="https://plus.google.com/+BaptisteWicht">
<img src="../../../assets/img/google_plus.png" alt="Follow +BaptisteWicht on Google+"></a>
</li>
</ul>
</div>

</nav>
</div> 
<div class="col-sm-9 col-lg-10">
<div id="content"></div>
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">Improve ETL compile-time with Precompiled Headers</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">
Baptiste Wicht
</span></p>
<p class="dateline"><a href="#" rel="bookmark"><time class="published dt-published" datetime="2015-06-20T15:08:31+02:00" itemprop="datePublished" title="2015-06-20 15:08">2015-06-20 15:08</time></a></p>
<p class="commentline">
<a href="improve-etl-compile-time-with-precompiled-headers.html#disqus_thread" data-disqus-identifier="cache/posts/2015/06/improve-etl-compile-time-with-precompiled-headers.html">Comments</a>
</p>
<p class="sourceline"><a href="improve-etl-compile-time-with-precompiled-headers.rst" class="sourcelink">Source</a></p>
</div>
</header><div class="e-content entry-content" itemprop="articleBody text">
<div>
<p>Very recently, I started trying to improve the compile-time of the ETL test suite. While not critical, it is always better to have tests that compile as fast as possible. In a <a class="reference external" href="http://baptiste-wicht.com/posts/2015/06/how-i-improved-a-bit-compile-time-of-etl.html">previous post</a>, I was able to improve the time a bit by improve the makefile, using pragra once and avoiding <cite>&lt;iostream&gt;</cite> headers. With these techniques, I reduced the compile-time from 87.5 to 84.1, which is not bad, but not as good as I would have expected.</p>
<p>In the previous, I had not tried to use Precompiled Headers (PCH) to improve the compile time, so I thought it would be a good time to do it.</p>
<div class="section" id="precompiled-headers">
<h2>Precompiled Headers</h2>
<p>Precompiled Headers are an option of the compiler, where one header gets compiled. Normally, you only compile source files into object files, but you can also compile headers, although it is not the same thing. When a compiler compiles a header, it can do a lot of preprocessing (macros, includes, AST, symbols) and then store all the results into a precompiled header file. Once you compile the source files, the compiler will try to use the precompiled header file instead of the real header file. Of course, this can breaks the C++ standard since with that a header can not have different behaviour based on macros for instance. For these reasons (and probably implementation reasons as well), precompiled headers are really limited.</p>
<p>If we take the case of G++, G++ will consider the precompiled header file instead of the standard header only if (for a complete list, take a look at the GCC docs):</p>
<ul class="simple">
<li>The same compilation flags are the same between the two compilations</li>
<li>The same compiler binary is used for the compilations</li>
<li>Only one precompiled header can be used in each compilation</li>
<li>The same macros must be defined</li>
<li>The include of the header must be before every possible C/C++ token</li>
</ul>
<p>If all these conditions are met and you try to <cite>#include "header.hpp</cite> and there is a header.hpp.gch (the precompiled file) available in the search path, then the precompiled header will be taken instead of the standard one.</p>
<p>With clang, it is a bit different because the precompiled header cannot be included automatically, but has to be included explicitely in the source code, meaning you have to modify your code for this technique to work. This is a bad thing in my opinion, you never should have to modify your code to profit from a compiler feature. This is why I haven't used and don't plan to use precompiled headers with clang.</p>
</div>
<div class="section" id="how-to">
<h2>How-to</h2>
<p>Once you know all the conditions for a precompiled header to be automatically included, it is quite straightforward to use them.</p>
<p>To generate a PCH file is easy:</p>
<pre class="literal-block">g++ options header.hpp
</pre>
<p>This will generate header.hpp.gch. When you compile your source file using header.hpp, you don't have anything to do, you just have to compile it as usually and if all the conditions are met, the PCH file will be used instead of the other header.</p>
</div>
<div class="section" id="results-and-conclusion">
<h2>Results and conclusion</h2>
<p>I added precompiled header support into my <a class="reference external" href="https://github.com/wichtounet/make-utils">make-utils</a> collection of Makefile utilities and tested it on ETL. I have precompiled a header that itself included Catch and ETL. Almost all test files are including this header. With this change, I went from 84 seconds to 78seconds. Headers are taking 1.5seconds to be precompiled. This is a nice result I think. If your application is not as template-heavy as mine or if you have more source files, you should expect better improvements.</p>
<p>To conclude, even if precompiled headers are a sound way to reduce compile-time, they are really limited to some cases. I'm not a fan of the feature overally. It is not portable between compilers and not standard. Anyway, if you are really in need of saving some time, you should not hesitate too much ;)</p>
</div>
</div>
</div>
<aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../../categories/c%2B%2B.html" rel="tag">C++</a></li>
<li><a class="tag p-category" href="../../../categories/compilers.html" rel="tag">Compilers</a></li>
<li><a class="tag p-category" href="../../../categories/etl.html" rel="tag">etl</a></li>
<li><a class="tag p-category" href="../../../categories/gcc.html" rel="tag">gcc</a></li>
<li><a class="tag p-category" href="../../../categories/performances.html" rel="tag">Performances</a></li>
</ul>
<ul class="pager hidden-print">
<li class="previous">
<a href="how-i-improved-a-bit-compile-time-of-etl.html" rel="prev" title="How I improved (a bit) compile time of ETL ?">Previous post</a>
</li>
<li class="next">
<a href="../07/simulate-static_if-with-c11c14.html" rel="next" title="Simulate static_if with C++11/C++14">Next post</a>
</li>
</ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
<div id="disqus_thread"></div>
<script>
        var disqus_shortname ="blogwichtounet",
            disqus_url="http://baptiste-wicht.com/posts/2015/06/improve-etl-compile-time-with-precompiled-headers.html",
        disqus_title="Improve ETL compile-time with Precompiled Headers",
        disqus_identifier="cache/posts/2015/06/improve-etl-compile-time-with-precompiled-headers.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
<a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>
</section></article><script>var disqus_shortname="blogwichtounet";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>
</div> 
</div>

</div>



<footer>
Contents Â© 2017 <a href="/cdn-cgi/l/email-protection#1c7e7d6c68756f68796b757f74685c7b717d7570327f7371">Baptiste Wicht</a> - Powered by <a href="http://getnikola.com" rel="nofollow">Nikola</a> - License:
<a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="padding-left:5px;border-width:0" src="../../../assets/img/cc.png"></a>
<ul class="footer_inline_ul">
<li>
<a href="improve-etl-compile-time-with-precompiled-headers.rst" id="sourcelink">Source</a>
</li>
</ul></footer><script src="/cdn-cgi/scripts/78d64697/cloudflare-static/email-decode.min.js"></script><script src="../../../assets/js/all-nocdn.js"></script>
</body>
</html>
