<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>How to speed up RAID (5-6) growing with mdadm ? | Blog blog("Baptiste Wicht");</title>
<script src="/cdn-cgi/apps/head/98vpnawSZZMscPn4oDND-ZgswjM.js"></script><link href="../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../../rss.xml">
<link rel="canonical" href="http://baptiste-wicht.com/posts/2015/03/how-to-speed-up-raid-5-6-growing-with-mdadm.html">
<!--[if lt IE 9]><script src="../../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Baptiste Wicht">
<link rel="prev" href="named-optional-template-parameters-compile-time.html" title="Named Optional Template parameters to configure a class at compile-time" type="text/html">
<link rel="next" href="../05/sonar-cpp-community-plugin-review.html" title="Sonar C++ Community Plugin Review" type="text/html">
<meta property="og:site_name" content='Blog blog("Baptiste Wicht");'>
<meta property="og:title" content="How to speed up RAID (5-6) growing with mdadm ?">
<meta property="og:url" content="http://baptiste-wicht.com/posts/2015/03/how-to-speed-up-raid-5-6-growing-with-mdadm.html">
<meta property="og:description" content="Yesterday, I added my 11th disk to my RAID 6 array. As the last time it took my more than 20 hours, I spent some time investigating how to speed things up and this post contains some tips on how to ac">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2015-03-07T15:01:56+01:00">
<meta property="article:tag" content="Gentoo">
<meta property="article:tag" content="Hardware">
<meta property="article:tag" content="Home Server">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="LVM">
<link href="../../../favicon.ico" rel="icon" type="image/x-icon">
<link rel="publisher" href="https://plus.google.com/+BaptisteWicht">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-2175227-7', 'auto');
  var metas = document.getElementsByTagName('meta'), tagsList = [];
  for (var i=0; i<metas.length; i++) {
    if (metas[i].getAttribute('property') == 'article:tag') {
      tagsList.push( metas[i].getAttribute('content'));
    }
  }
  ga('set', 'dimension1', tagsList.join('|'));
  ga('send', 'pageview');
</script>
</head>
<body>

<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
<div class="container-fluid">

<div class="row">
<div class="col-sm-3 col-lg-2">
<nav class="navbar navbar-inverse navbar-fixed-side"><div class="navbar-header">
<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
<span class="sr-only">Toggle navigation</span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
</button>
<a class="navbar-brand" href="http://baptiste-wicht.com/">
<span id="blog-title">Blog blog("Baptiste Wicht");</span>
</a>
</div>

<div class="collapse navbar-collapse navbar-ex1-collapse">
<ul class="nav navbar-nav">
<li>
<a href="../../../stories/about.html">About</a>
</li>
<li>
<a href="../../../stories/publications.html">Publications</a>
</li>
<li>
<a href="../../../stories/projects.html">Projects</a>
</li>
<li>
<a href="../../../categories/index.html">Tags</a>
</li>
<li>
<a href="../../../archive.html">Archives</a>
</li>
<li>
<a href="http://feeds.feedburner.com/BaptisteWicht">RSS</a>
</li>
<li class="navbar-content">
<h3>Related posts</h3>
</li>
<li><a href="../../2017/08/how-to-fix-mdadm-raid5-raid6-growing-stuck-at-0ks.html">How to fix mdadm RAID5 / RAID6 growing stuck at 0K/s ?</a></li>
<li><a href="../../2014/05/changing-root-hard-disk-gentoo-lvm-grub2.html">Changing root hard disk on Gentoo with LVM and Grub2</a></li>
<li><a href="../../2010/02/hardware-guide-hard-disks.html">Hardware Guide : The Hard Disks</a></li>
<li><a href="../../2014/01/home-server-adventure-step-3.html">Home Server Adventure – Step 3</a></li>
<li><a href="../../2011/06/upload-files-to-ftp-using-bash.html">Upload files to FTP using Bash</a></li>
<li><a href="../../2009/12/improve-performance-web-site.html">Improve performance of your web site with Page Speed</a></li>
<li class="navbar-block">
<li class="wicht-navbar-right">
<a target="_blank" title="Follow @wichtounet on Twitter" href="https://twitter.com/wichtounet">
<img src="../../../assets/img/twitter.png" alt="Follow @wichtounet on Twitter"></a>
</li>
<li class="wicht-navbar-right">
<a target="_blank" title="Follow +BaptisteWicht on Google+" href="https://plus.google.com/+BaptisteWicht">
<img src="../../../assets/img/google_plus.png" alt="Follow +BaptisteWicht on Google+"></a>
</li>
</ul>
</div>

</nav>
</div> 
<div class="col-sm-9 col-lg-10">
<div id="content"></div>
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">How to speed up RAID (5-6) growing with mdadm ?</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">
Baptiste Wicht
</span></p>
<p class="dateline"><a href="#" rel="bookmark"><time class="published dt-published" datetime="2015-03-07T15:01:56+01:00" itemprop="datePublished" title="2015-03-07 15:01">2015-03-07 15:01</time></a></p>
<p class="commentline">
<a href="how-to-speed-up-raid-5-6-growing-with-mdadm.html#disqus_thread" data-disqus-identifier="cache/posts/2015/03/how-to-speed-up-raid-5-6-growing-with-mdadm.html">Comments</a>
</p>
<p class="sourceline"><a href="how-to-speed-up-raid-5-6-growing-with-mdadm.rst" class="sourcelink">Source</a></p>
</div>
</header><div class="e-content entry-content" itemprop="articleBody text">
<div>
<p>Yesterday, I added my 11th disk to my RAID 6 array. As the last time it took my more than 20 hours, I spent some time investigating how to speed things up and this post contains some tips on how to achieve good grow performances. With these tips, I have been able to reach a speed of about 55K in average during reshape. It did finish in about 13 hours.</p>
<p>First, take into account that some of these tips may depend on your configuration. In my case, this server is only used for this RAID, so I don't care if the CPU is used a lot during rebuild or if other processes are suffering from the load. This may not be the case with your configuration. Moreover, I speak only of hard disks, if you use SSD RAID, there are probably better way of tuning the rebuild (or perhaps it is fast enough). Finally, you have know that a RAID reshape is going to be slow, there is no way you'll grow a 10+ RAID array in one hour. G</p>
<p>In the examples, I use /dev/md0 as the raid array, you'll have to change this to your array name.</p>
<p>The first 3 tips can be used even after the rebuild has started and you should see the differences in real-time. But, these 3 tips will also be erased after each reboot.</p>
<div class="section" id="increase-speed-limits">
<h2>Increase speed limits</h2>
<p>The easiest thing to do is to increase the system speed limits on raid. You can see the current limits on your system by using these commands:</p>
<pre class="code bash"><a name="rest_code_a72e40a4d3b346bbb58b387f1be753af-1"></a>sysctl dev.raid.speed_limit_min
<a name="rest_code_a72e40a4d3b346bbb58b387f1be753af-2"></a>sysctl dev.raid.speed_limit_max
</pre>
<p>These values are set in Kibibytes per second (KiB/s).</p>
<p>You can put them to high values:</p>
<pre class="code bash"><a name="rest_code_d5fdf6517c5948a9a7e553caf8534be2-1"></a>sysctl -w dev.raid.speed_limit_min<span class="o">=</span><span class="m">100000</span>
<a name="rest_code_d5fdf6517c5948a9a7e553caf8534be2-2"></a>sysctl -w dev.raid.speed_limit_max<span class="o">=</span><span class="m">500000</span>
</pre>
<p>At least with these values, you won't be limited by the system.</p>
</div>
<div class="section" id="increase-stripe-cache-size">
<h2>Increase stripe cache size</h2>
<p>By allowing the array to use more memory for its stripe cache, you may improve the performances. In some cases, it can improve performances by up to 6 times. By default, the size of the stripe cache is 256, in pages. By default, Linux uses 4096B pages. If you use 256 pages for the stripe cache and you have 10 disks, the cache would use 10*256*4096=10MiB of RAM. In my case, I have increased it to 4096:</p>
<pre class="code bash"><a name="rest_code_311bcc62c93d467b9a97d4132c8c525f-1"></a><span class="nb">echo</span> <span class="m">4096</span> &gt; /sys/block/md0/md/stripe_cache_size
</pre>
<p>The maximum value is 32768. If you have many disks, this may well take all your available memory. I don't think values higher than 4096 will improve performance, but feel free to try it ;)</p>
</div>
<div class="section" id="increase-read-ahead">
<h2>Increase read-ahead</h2>
<p>If configured too low, the read-ahead of your array may make things slower.</p>
<p>You can see get the current read-ahead value with this command:</p>
<pre class="code bash"><a name="rest_code_ba5e35cedbe4486b94f6f56fe49bf9f5-1"></a>blockdev --getra /dev/md0
</pre>
<p>These values are in 512B sector. You can set it to 32MB to be sure:</p>
<pre class="code bash"><a name="rest_code_3e437f76fd0945379002cd0af450f8d7-1"></a>blockdev --setra <span class="m">65536</span> /dev/md0
</pre>
<p>This can improve the performances, but don't expect this to be a game-changer unless it was configured really low at the first place.</p>
</div>
<div class="section" id="tip-reshape-stuck-at-0k-s">
<h2>Tip: Reshape stuck at 0K/s</h2>
<p>If reshape starts, but with a speed of 0K/s, you can try to issue this simple
command:</p>
<pre class="code bash"><a name="rest_code_de6bd13db14849e09a525cd4462ba01e-1"></a><span class="nb">echo</span> max &gt; /sys/block/md0/md/sync_max
</pre>
<p>And the reshape should start directly at your maximum speed.</p>
<p>The solution is the same if you are growing any type of RAID level with parity
(RAID5, RAID6, ...).</p>
</div>
<div class="section" id="bonus-speed-up-standard-resync-with-a-write-intent-bitmap">
<h2>Bonus: Speed up standard resync with a write-intent bitmap</h2>
<p>Although it won't speed up the growing of your array, this is something that you should do after the rebuild has finished. Write-intent bitmaps is a kind of map of what needs to be resynced. This is of great help in several cases:</p>
<ul class="simple">
<li>When the computer crash (power shutdown for instance)</li>
<li>If a disk is disconnected, then reconnected.</li>
</ul>
<p>In these case, it may totally avoid the need of a rebuild which is great in my opinion. Moreover, it does not take any space on the array since it uses space that is not usable by the array.</p>
<p>Here is how to enable it:</p>
<pre class="code bash"><a name="rest_code_75fe38a675fd443ea647ac19045a28ba-1"></a>mdadm --grow --bitmap<span class="o">=</span>internal /dev/md0
</pre>
<p>However, it may cause some write performance degradation. In my case, I haven't seen any noticeable degradation, but if it is the case, you may want to disable it:</p>
<pre class="code bash"><a name="rest_code_4c8b6fc796584ccf8d338188fcda5b60-1"></a>mdadm --grow --bitmap<span class="o">=</span>none /dev/md0
</pre>
</div>
<div class="section" id="bonus-monitor-rebuild-process">
<h2>Bonus: Monitor rebuild process</h2>
<p>If you want to monitor the build process, you can use the watch command:</p>
<pre class="code bash"><a name="rest_code_b7239689216d4e0e888ed37631bc6dfd-1"></a>watch cat /proc/mdstat
</pre>
<p>With that you'll see the rebuild going in real-time.</p>
<p>You can also monitor the I/O statistics:</p>
<pre class="code bash"><a name="rest_code_3dc0db910d214ab4a562397b73144ba4-1"></a>watch iostat -k <span class="m">1</span> <span class="m">2</span>
</pre>
</div>
<div class="section" id="bonus-how-to-grow-a-raid-5-6-array">
<h2>Bonus: How to grow a RAID 5-6 array</h2>
<p>As a sidenote, this section indicates how to grow an array. If you want to add the disk /dev/sdl to the array /dev/md0, you'll first have to add it:</p>
<pre class="code bash"><a name="rest_code_63f50495ecda401eac74ace70e7cd9e3-1"></a>mdadm --add /dev/md0 /dev/sdl
</pre>
<p>This will add the disk as a spare disk. If you had 5 disks before, you'll want to grow it to 6:</p>
<pre class="code bash"><a name="rest_code_7a054f3cfad34df796939f3c516ad803-1"></a>mdadm --grow --backup-file<span class="o">=</span>/root/grow_md0_backup_file --raid-devices<span class="o">=</span><span class="m">6</span> /dev/md0
</pre>
<p>The backup file must be on another disk of course. The backup file is optional but improves the chance of success if you have a power shutdown or another form of unexpected shutdown. If you know what you're doing, you can grow it without backup-file:</p>
<pre class="code bash"><a name="rest_code_2f9c5a918fab4d29b1e7b3e7dec30e1d-1"></a>mdadm --grow --raid-devices<span class="o">=</span><span class="m">6</span> /dev/md0
</pre>
<p>This command will return almost instantly, but the actual reshape won't likely be finished for hours (maybe days).</p>
<p>Once the rebuild is finished, you'll still have to extend the partitions with resize2fs. If you use LVM on top of the array, you'll have to resize the Physical Volume (PV) first:</p>
<pre class="code bash"><a name="rest_code_2d9b9529177c4abca5edde06f57ca124-1"></a>pvresize /dev/md0
</pre>
<p>and then extend the Logical Volume (s) (LV). For instance, if you want to add 1T to a LV named /dev/vgraid/work:</p>
<pre class="code bash"><a name="rest_code_3e89c3c80a5e4b3e888a95adaae853b3-1"></a>vgextend -r -L+1T /dev/vgraid/work
</pre>
<p>The -r option will automatically resize the underlying filesystem. Otherwise, you'd still have to resize it with resize2fs.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>These are the changes I have found that speed up the reshape process. There are others that you may test in your case. For instance, in some systems disabling NCQ on each disk may help.</p>
<p>I hope that these tips will help you doing fast rebuilds in your RAID array :)</p>
</div>
</div>
</div>
<aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../../categories/gentoo.html" rel="tag">Gentoo</a></li>
<li><a class="tag p-category" href="../../../categories/hardware.html" rel="tag">Hardware</a></li>
<li><a class="tag p-category" href="../../../categories/home-server.html" rel="tag">Home Server</a></li>
<li><a class="tag p-category" href="../../../categories/linux.html" rel="tag">Linux</a></li>
<li><a class="tag p-category" href="../../../categories/lvm.html" rel="tag">LVM</a></li>
</ul>
<ul class="pager hidden-print">
<li class="previous">
<a href="named-optional-template-parameters-compile-time.html" rel="prev" title="Named Optional Template parameters to configure a class at compile-time">Previous post</a>
</li>
<li class="next">
<a href="../05/sonar-cpp-community-plugin-review.html" rel="next" title="Sonar C++ Community Plugin Review">Next post</a>
</li>
</ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
<div id="disqus_thread"></div>
<script>
        var disqus_shortname ="blogwichtounet",
            disqus_url="http://baptiste-wicht.com/posts/2015/03/how-to-speed-up-raid-5-6-growing-with-mdadm.html",
        disqus_title="How to speed up RAID (5-6) growing with mdadm ?",
        disqus_identifier="cache/posts/2015/03/how-to-speed-up-raid-5-6-growing-with-mdadm.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
<a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>
</section></article><script>var disqus_shortname="blogwichtounet";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>
</div> 
</div>

</div>



<footer>
Contents © 2017 <a href="/cdn-cgi/l/email-protection#24464554504d575041534d474c50644349454d480a474b49">Baptiste Wicht</a> - Powered by <a href="http://getnikola.com" rel="nofollow">Nikola</a> - License:
<a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="padding-left:5px;border-width:0" src="../../../assets/img/cc.png"></a>
<ul class="footer_inline_ul">
<li>
<a href="how-to-speed-up-raid-5-6-growing-with-mdadm.rst" id="sourcelink">Source</a>
</li>
</ul></footer><script src="/cdn-cgi/scripts/78d64697/cloudflare-static/email-decode.min.js"></script><script src="../../../assets/js/all-nocdn.js"></script>
</body>
</html>
